<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Impostor - Final Fixed</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            /* MODO OSCURO */
            --glass-bg: rgba(22, 33, 62, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #e94560;
            --text-main: #ffffff;
            --text-secondary: #bdc3c7;
            --btn-color: #0f3460;
            --danger-color: #ff4757;
            --success-color: #2ecc71;
            --input-bg: rgba(0, 0, 0, 0.5); 
            --option-bg: #000000;
            --option-text: #ffffff;
            --bg-gradient: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #1a1a2e);
        }

        /* MODO CLARO */
        body.light-mode {
            --glass-bg: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --accent-color: #ff6b6b;
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --btn-color: #54a0ff;
            --danger-color: #ff4757;
            --success-color: #1dd1a1;
            --input-bg: rgba(0, 0, 0, 0.05); 
            --option-bg: #ffffff;
            --option-text: #000000;
            --bg-gradient: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            overscroll-behavior-y: none;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: color 0.3s ease;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background-color: var(--glass-bg);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            max-width: 420px;
            width: 90%;
            height: 60%;
            margin: 20px auto;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* TOGGLE THEME */
        .theme-switch-wrapper { position: absolute; top: 25px; left: 20px; display: flex; align-items: center; z-index: 10; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: rgba(0,0,0,0.3); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; font-size: 14px; }
        .slider .icon { z-index: 1; pointer-events: none; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 20px; left: 4px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; z-index: 2; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        h1 { margin-bottom: 1.5rem; color: var(--accent-color); text-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 2.2rem; font-weight: 800; letter-spacing: -0.5px; margin-top: 10px; }
        .screen { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"], select { padding: 14px; border-radius: 14px; border: 1px solid var(--glass-border); width: 100%; box-sizing: border-box; font-size: 16px; background: var(--input-bg); color: var(--text-main); outline: none; transition: all 0.2s; appearance: none; -webkit-appearance: none; }
        input[type="text"]:focus, select:focus { background: rgba(125, 125, 125, 0.1); border-color: var(--accent-color); }
        select:disabled { opacity: 0.6; }
        select option { background-color: var(--option-bg); color: var(--option-text); }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23888888%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4-3.7%203.7-5.4%208-5.4%2013%200%205%201.8%209.3%205.4%2013l128%20128c3.7%203.7%208%205.4%2013%205.4s9.3-1.8%2013-5.4l128-128c3.7-3.7%205.4-8%205.4-13%200-5-1.8-9.3-5.4-13z%27%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 1em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        label { display: block; text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        button { background-color: var(--accent-color); color: white; border: none; padding: 16px 30px; border-radius: 16px; font-size: 1.1rem; cursor: pointer; width: 100%; font-weight: 700; transition: transform 0.1s; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.96); }
        button.small-btn { width: auto; padding: 0 20px; margin: 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; }
        button.secondary { background-color: var(--btn-color); box-shadow: none; }
        button.danger { background-color: var(--danger-color); margin-top: 25px; }
        button.exit-btn { width: auto; padding: 5px 12px; font-size: 0.8rem; background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); margin: 0; box-shadow: none; }
        .btn-start-margin { margin-top: 40px !important; }

        #player-list-lobby { list-style: none; padding: 0; margin: 20px 0; max-height: 150px; overflow-y: auto; scrollbar-width: thin; }
        .lobby-player { background: var(--input-bg); padding: 10px; margin: 5px 0; border-radius: 10px; text-align: left; display: flex; justify-content: space-between; border: 1px solid var(--glass-border); }
        .me-badge { font-size: 0.8rem; background: var(--success-color); padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; }
        .host-badge { font-size: 0.8rem; background: #f1c40f; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-right: 5px; }

        .role-card { background: var(--input-bg); color: var(--text-main); padding: 30px 20px; border-radius: 20px; margin: 25px 0; font-size: 2rem; font-weight: 800; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .imposter-reveal { background: rgba(255, 71, 87, 0.2); border: 1px solid var(--danger-color); color: var(--danger-color); }
        .hint-box { display: block; margin-top: 15px; font-size: 1.1rem; font-weight: 500; background: rgba(0,0,0,0.1); color: var(--text-main); padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; }
        
        #timer { font-size: 4.5rem; margin: 10px 0; font-weight: 800; color: var(--accent-color); font-family: 'Courier New', monospace; text-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .room-code-display { font-size: 3rem; font-weight: bold; letter-spacing: 5px; color: var(--success-color); margin: 10px 0; background: var(--input-bg); padding: 10px; border-radius: 10px; }

        #review-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--glass-bg); z-index: 2000; padding: 20px; box-sizing: border-box; display: none; flex-direction: column; justify-content: center; align-items: center; border-radius: 24px; backdrop-filter: blur(20px); overflow-y: auto; }
        .close-icon-overlay { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; color: var(--text-main); cursor: pointer; z-index: 2001; font-weight: bold; line-height: 1; }
        
        .lobby-settings-box { border-top: 1px solid var(--glass-border); padding-top: 15px; margin-top: 15px; text-align: left; }
        .host-badge-settings { font-size: 0.7rem; color: var(--success-color); float: right; font-weight: normal; margin-top: 3px; }
        .header-game { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; min-height: 30px;}
        .lobby-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox-theme">
            <input type="checkbox" id="checkbox-theme" onchange="toggleTheme()">
            <div class="slider round">
                <span class="icon" style="margin-left: 4px;">üåô</span>
                <span class="icon" style="margin-right: 4px;">‚òÄÔ∏è</span>
            </div>
        </label>
    </div>

    <div id="home-screen" class="screen active">
        <h1>üïµÔ∏è El Impostor<br><span style="font-size:1rem; opacity:0.7">Modo Online</span></h1>
        <input type="text" id="player-name-input" placeholder="Tu Nombre" maxlength="12">
        <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <button onclick="createRoom()">üëë Crear Nueva Sala</button>
            <p style="margin: 15px 0; opacity: 0.7;">- O -</p>
            <input type="text" id="room-code-input" placeholder="C√≥digo de Sala" style="text-transform: uppercase;">
            <button class="secondary" onclick="joinRoom()">Entrar en Sala</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-header">
            <button onclick="exitGame()" class="exit-btn">‚úï Salir</button>
        </div>
        <h2 style="font-size: 0.9rem; opacity: 0.7; margin-bottom:5px;">C√ìDIGO DE SALA:</h2>
        <div id="display-room-code" class="room-code-display">----</div>
        <p style="margin-bottom: 5px; opacity: 0.7; font-size: 0.9rem;">Jugadores:</p>
        <ul id="player-list-lobby"></ul>
        <div class="lobby-settings-box">
            <label>CONFIGURACI√ìN <span id="settings-status-text" class="host-badge-settings"></span></label>
            <select id="imposter-count" onchange="syncSettings()">
                <option value="1">1 Impostor</option>
                <option value="2">2 Impostores</option>
            </select>
            <select id="category-select" onchange="syncSettings()">
                <option value="random">üé≤ Categor√≠a Aleatoria</option>
                <option value="lugares">üåç Lugares</option>
                <option value="comida">üçï Comida</option>
                <option value="animales">üê∂ Animales</option>
                <option value="profesiones">üíº Profesiones</option>
                <option value="deportes">‚öΩ Deportes</option>
                <option value="instrumentos">üé∏ Instrumentos</option>
                <option value="ropa">üëï Ropa</option>
            </select>
            <select id="difficulty-select" onchange="syncSettings()">
                <option value="medium">üü° Pista Media</option>
                <option value="hard">üî¥ Pista Dif√≠cil</option>
                <option value="very_hard">üíÄ Pista Muy Dif√≠cil</option>
            </select>
            <button id="btn-start-game" onclick="startGame()" style="display:none;">üöÄ EMPEZAR PARTIDA</button>
            <p id="waiting-msg" style="display:none; color: var(--success-color); animation: pulse 1.5s infinite; text-align: center; margin-top: 15px;">Esperando al anfitri√≥n...</p>
        </div>
    </div>

    <div id="role-screen" class="screen">
        <h2>Tu Rol</h2>
        <div id="role-card-display" class="role-card">
            <span id="role-text">...</span>
            <div id="role-hint" class="hint-box" style="display:none"></div>
        </div>
        <p id="category-display" style="opacity: 0.7;"></p>
        <button onclick="confirmRoleSeen()">Entendido, Ocultar</button>
    </div>

    <div id="game-screen" class="screen" style="position: relative;">
        <div class="header-game">
            <button onclick="exitGame()" class="exit-btn">‚úï Salir</button>
        </div>
        <div id="review-overlay">
            <div class="close-icon-overlay" onclick="closeRoleReview()">‚úï</div>
            <h2 style="margin-bottom: 20px;">Tu Rol Secreto</h2>
            <div id="review-card-display" class="role-card" style="width: 100%;">
                <span id="review-role-text">...</span>
                <div id="review-role-hint" class="hint-box" style="display:none"></div>
            </div>
            <p id="review-category-display" style="opacity: 0.7;"></p>
            <button onclick="closeRoleReview()" class="secondary">Cerrar</button>
        </div>
        <div style="background: var(--input-bg); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--glass-border);">
            <p style="margin:0; font-size:0.8rem; opacity:0.7;">EMPIEZA HABLANDO:</p>
            <h2 id="starter-name" style="margin:5px 0;">?</h2>
        </div>
        <div id="waiting-others-msg" style="display:none; margin: 20px 0; color: var(--text-secondary); font-style: italic;">
            Esperando a que todos vean su rol...
        </div>
        <div id="timer" style="display:block;">03:00</div>
        <button id="btn-review-role" onclick="openRoleReview()" class="secondary" style="font-size: 0.9rem; padding: 10px; margin-bottom: 20px;">üëÅÔ∏è Recordar mi palabra</button>
        <div id="host-game-controls" style="display:none;">
            <button class="danger" onclick="endGameGlobal()">üö® RESOLVER / VOTAR</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="header-game">
            <button onclick="exitGame()" class="exit-btn">‚úï Salir</button>
        </div>
        <h1>FIN DE PARTIDA</h1>
        <div style="background: var(--input-bg); padding: 20px; border-radius: 15px; border: 2px solid var(--accent-color);">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">IMPOSTOR(ES):</p>
            <div id="result-impostors" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-color); margin: 10px 0;">-</div>
            <hr style="border-color: var(--glass-border)">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">PALABRA SECRETA:</p>
            <div id="result-word" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-top: 5px;">-</div>
        </div>
        <div id="host-restart-controls" style="display:none;">
            <button onclick="returnToLobbyGlobal()">üîÑ JUGAR OTRA VEZ</button>
        </div>
        <p id="waiting-restart" style="display:none; margin-top:20px;">Esperando reinicio...</p>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCD9EZAZldGoBHv5-v9jQ8wfOSVPL9mu60",
        authDomain: "juego-del-impostor-9318e.firebaseapp.com",
        databaseURL: "https://juego-del-impostor-9318e-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juego-del-impostor-9318e",
        storageBucket: "juego-del-impostor-9318e.firebasestorage.app",
        messagingSenderId: "952474577416",
        appId: "1:952474577416:web:3b13fa3169b12114787fbd",
        measurementId: "G-704F1P5P2J"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    let myName = "";
    let myId = localStorage.getItem('impostor_myId') || ""; 
    let roomId = "";
    let isHost = false;
    let playersInRoom = [];
    let timerInterval;
    let mySavedRoleData = null; 

    // --- BASE DE DATOS (COMPLETA) ---
    const database = {
            lugares: [
                { word: "Playa", hints: { easy: "Verano", medium: "Arena", hard: "Sal", very_hard: "Marea" } },
                { word: "Hospital", hints: { easy: "M√©dico", medium: "Silencio", hard: "Bata", very_hard: "Guardia" } },
                { word: "Escuela", hints: { easy: "Alumnos", medium: "Pizarra", hard: "Recreo", very_hard: "Septiembre" } },
                { word: "Cine", hints: { easy: "Pel√≠cula", medium: "Palomitas", hard: "Butaca", very_hard: "Estreno" } },
                { word: "Supermercado", hints: { easy: "Compra", medium: "Carrito", hard: "Pasillo", very_hard: "C√≥digo de barras" } },
                { word: "Avi√≥n", hints: { easy: "Vuelo", medium: "Nubes", hard: "Azafata", very_hard: "Presi√≥n" } },
                { word: "Zool√≥gico", hints: { easy: "Animales", medium: "Jaula", hard: "Domingo", very_hard: "Cautiverio" } },
                { word: "Biblioteca", hints: { easy: "Libros", medium: "Silencio", hard: "Pr√©stamo", very_hard: "Estanter√≠a" } },
                { word: "Gimnasio", hints: { easy: "Deporte", medium: "Sudor", hard: "Pesas", very_hard: "Membres√≠a" } },
                { word: "Restaurante", hints: { easy: "Comida", medium: "Men√∫", hard: "Propina", very_hard: "Reserva" } },
                { word: "Parque", hints: { easy: "Jugar", medium: "Banco", hard: "Palomas", very_hard: "Tobog√°n" } },
                { word: "Museo", hints: { easy: "Arte", medium: "Antiguo", hard: "Gu√≠a", very_hard: "Vitrina" } },
                { word: "Discoteca", hints: { easy: "Baile", medium: "Noche", hard: "Luces", very_hard: "Sello" } },
                { word: "Farmacia", hints: { easy: "Medicinas", medium: "Cruz verde", hard: "Receta", very_hard: "Guardia" } },
                { word: "Aeropuerto", hints: { easy: "Viaje", medium: "Maletas", hard: "Control", very_hard: "Puerta de embarque" } },
                { word: "Estadio", hints: { easy: "Partido", medium: "Grada", hard: "Afici√≥n", very_hard: "C√©sped" } },
                { word: "C√°rcel", hints: { easy: "Preso", medium: "Rejas", hard: "Naranja", very_hard: "Visita" } },
                { word: "Cementerio", hints: { easy: "Tumbas", medium: "Flores", hard: "Cipr√©s", very_hard: "Silencio" } },
                { word: "Banco", hints: { easy: "Dinero", medium: "Cajero", hard: "Inter√©s", very_hard: "Cola" } },
                { word: "Hotel", hints: { easy: "Dormir", medium: "Recepci√≥n", hard: "Llave", very_hard: "Estrellas" } },
                { word: "Piscina", hints: { easy: "Nadar", medium: "Cloro", hard: "Gorro", very_hard: "Trampol√≠n" } },
                { word: "Teatro", hints: { easy: "Actor", medium: "Tel√≥n", hard: "Aplausos", very_hard: "Drama" } },
                { word: "Iglesia", hints: { easy: "Misa", medium: "Domingo", hard: "Campana", very_hard: "Velas" } },
                { word: "Monta√±a", hints: { easy: "Altura", medium: "Nieve", hard: "Escalar", very_hard: "Cima" } },
                { word: "Desierto", hints: { easy: "Arena", medium: "Calor", hard: "Cactus", very_hard: "Espejismo" } },
                { word: "Selva", hints: { easy: "Verde", medium: "Humedad", hard: "Tarz√°n", very_hard: "Liana" } },
                { word: "Isla", hints: { easy: "Mar", medium: "Palmera", hard: "N√°ufrago", very_hard: "Tesoro" } },
                { word: "Circo", hints: { easy: "Payaso", medium: "Carpa", hard: "Trapecio", very_hard: "Leones" } },
                { word: "Casino", hints: { easy: "Juego", medium: "Fichas", hard: "Suerte", very_hard: "Ruleta" } },
                { word: "Castillo", hints: { easy: "Rey", medium: "Piedra", hard: "Foso", very_hard: "Torre" } }
            ],
            comida: [
                { word: "Pizza", hints: { easy: "Queso", medium: "Italia", hard: "Caja", very_hard: "Tri√°ngulo" } },
                { word: "Sushi", hints: { easy: "Arroz", medium: "Jap√≥n", hard: "Palillos", very_hard: "Crudo" } },
                { word: "Hamburguesa", hints: { easy: "Carne", medium: "Pan", hard: "Ketchup", very_hard: "R√°pida" } },
                { word: "Helado", hints: { easy: "Fr√≠o", medium: "Verano", hard: "Cucurucho", very_hard: "Derretido" } },
                { word: "Chocolate", hints: { easy: "Dulce", medium: "Marr√≥n", hard: "Suiza", very_hard: "Cacao" } },
                { word: "Ensalada", hints: { easy: "Verde", medium: "Sano", hard: "Aceite", very_hard: "Lechuga" } },
                { word: "Paella", hints: { easy: "Arroz", medium: "Domingo", hard: "Amarillo", very_hard: "Socarrat" } },
                { word: "Tacos", hints: { easy: "M√©xico", medium: "Tortilla", hard: "Picante", very_hard: "Lim√≥n" } },
                { word: "Espaguetis", hints: { easy: "Pasta", medium: "Largo", hard: "Tomate", very_hard: "Absorber" } },
                { word: "Huevo frito", hints: { easy: "Desayuno", medium: "Sart√©n", hard: "Yema", very_hard: "Pan" } },
                { word: "Sopa", hints: { easy: "Cuchara", medium: "Caliente", hard: "Invierno", very_hard: "Fideos" } },
                { word: "Pan", hints: { easy: "Harina", medium: "Horno", hard: "Barra", very_hard: "Miga" } },
                { word: "Queso", hints: { easy: "Rat√≥n", medium: "Leche", hard: "Agujeros", very_hard: "Olor" } },
                { word: "Manzana", hints: { easy: "Fruta", medium: "Roja", hard: "Blancanieves", very_hard: "Doctor" } },
                { word: "Pl√°tano", hints: { easy: "Amarillo", medium: "Mono", hard: "Curva", very_hard: "Potasio" } },
                { word: "Caf√©", hints: { easy: "Ma√±ana", medium: "Negro", hard: "Despertar", very_hard: "Cafe√≠na" } },
                { word: "Cerveza", hints: { easy: "Alcohol", medium: "Espuma", hard: "Rubia", very_hard: "Cebada" } },
                { word: "Vino", hints: { easy: "Uva", medium: "Copa", hard: "Tinto", very_hard: "Bodega" } },
                { word: "Palomitas", hints: { easy: "Cine", medium: "Ma√≠z", hard: "Sal", very_hard: "Explosi√≥n" } },
                { word: "Sandwich", hints: { easy: "Pan molde", medium: "Tri√°ngulo", hard: "Mixto", very_hard: "Ingl√©s" } },
                { word: "Tortilla", hints: { easy: "Huevo", medium: "Patata", hard: "Vuelta", very_hard: "Cebolla" } },
                { word: "Croquetas", hints: { easy: "Bechamel", medium: "Abuela", hard: "Fritura", very_hard: "Restos" } },
                { word: "Jam√≥n", hints: { easy: "Cerdo", medium: "Espa√±a", hard: "Pata", very_hard: "Serrano" } },
                { word: "Galleta", hints: { easy: "Dulce", medium: "Leche", hard: "Horno", very_hard: "Crujiente" } },
                { word: "Pastel", hints: { easy: "Cumplea√±os", medium: "Velas", hard: "Dulce", very_hard: "Porci√≥n" } },
                { word: "Yogur", hints: { easy: "Cremoso", medium: "Cuchara", hard: "Leche", very_hard: "Tapa" } },
                { word: "Kebab", hints: { easy: "Rollo", medium: "Carne", hard: "Salsa", very_hard: "Madrugada" } },
                { word: "Chicle", hints: { easy: "Masticar", medium: "Globo", hard: "Pegajoso", very_hard: "Menta" } },
                { word: "Miel", hints: { easy: "Abeja", medium: "Dulce", hard: "Oso", very_hard: "Pegajoso" } },
                { word: "Arroz", hints: { easy: "Blanco", medium: "Chino", hard: "Grano", very_hard: "Boda" } }
            ],
            animales: [
                { word: "Alejandro", hints: { easy: "Andaluz cordob√©s ", medium: "Amigo", hard: "es un poco goofy", very_hard: "se parti√≥ la uretra" } },
                { word: "Perro", hints: { easy: "Ladrido", medium: "Amigo", hard: "Hueso", very_hard: "Correa" } },
                { word: "Gato", hints: { easy: "Maullido", medium: "Bigotes", hard: "Siete vidas", very_hard: "Arena" } },
                { word: "Le√≥n", hints: { easy: "Rey", medium: "Selva", hard: "Melena", very_hard: "Rugido" } },
                { word: "Elefante", hints: { easy: "Grande", medium: "Trompa", hard: "Memoria", very_hard: "Marfil" } },
                { word: "Tibur√≥n", hints: { easy: "Mar", medium: "Dientes", hard: "Aleta", very_hard: "Miedo" } },
                { word: "Ping√ºino", hints: { easy: "Fr√≠o", medium: "Ave", hard: "Frac", very_hard: "Hielo" } },
                { word: "Mono", hints: { easy: "Banana", medium: "√Årbol", hard: "Parecido", very_hard: "Cola" } },
                { word: "Serpiente", hints: { easy: "Larga", medium: "Veneno", hard: "Arrastrarse", very_hard: "Siseo" } },
                { word: "√Åguila", hints: { easy: "Volar", medium: "Garra", hard: "Visi√≥n", very_hard: "Pico" } },
                { word: "Ballena", hints: { easy: "Gigante", medium: "Mar", hard: "Mam√≠fero", very_hard: "Espir√°culo" } },
                { word: "Jirafa", hints: { easy: "Alta", medium: "Cuello", hard: "Manchas", very_hard: "√Åfrica" } },
                { word: "Caballo", hints: { easy: "Montar", medium: "Galope", hard: "Crin", very_hard: "Establo" } },
                { word: "Vaca", hints: { easy: "Leche", medium: "Granja", hard: "Muu", very_hard: "Pasto" } },
                { word: "Cerdo", hints: { easy: "Rosa", medium: "Jam√≥n", hard: "Barro", very_hard: "Morro" } },
                { word: "Oveja", hints: { easy: "Lana", medium: "Reba√±o", hard: "Dormir", very_hard: "Bala" } },
                { word: "Gallina", hints: { easy: "Huevo", medium: "Granja", hard: "Plumas", very_hard: "Cresta" } },
                { word: "Rat√≥n", hints: { easy: "Peque√±o", medium: "Queso", hard: "Trampa", very_hard: "Cola" } },
                { word: "Murci√©lago", hints: { easy: "Noche", medium: "Volar", hard: "Cueva", very_hard: "Radar" } },
                { word: "Cocodrilo", hints: { easy: "Rio", medium: "Dientes", hard: "Piel", very_hard: "Verde" } },
                { word: "Tortuga", hints: { easy: "Lenta", medium: "Caparaz√≥n", hard: "Verde", very_hard: "Longeva" } },
                { word: "Rana", hints: { easy: "Saltar", medium: "Verde", hard: "Pr√≠ncipe", very_hard: "Charca" } },
                { word: "Oso", hints: { easy: "Miel", medium: "Hibernar", hard: "Pelo", very_hard: "Garra" } },
                { word: "Lobo", hints: { easy: "Aullar", medium: "Luna", hard: "Manada", very_hard: "Caperucita" } },
                { word: "Canguro", hints: { easy: "Australia", medium: "Saltar", hard: "Bolsa", very_hard: "Boxeo" } },
                { word: "Panda", hints: { easy: "Bamb√∫", medium: "China", hard: "Blanco y negro", very_hard: "Oso" } },
                { word: "Delf√≠n", hints: { easy: "Inteligente", medium: "Mar", hard: "Salto", very_hard: "Sonar" } },
                { word: "Pulpo", hints: { easy: "Tent√°culos", medium: "Tinta", hard: "Mar", very_hard: "Ocho" } },
                { word: "Ara√±a", hints: { easy: "Patas", medium: "Telara√±a", hard: "Miedo", very_hard: "Veneno" } },
                { word: "Mosquito", hints: { easy: "Picadura", medium: "Sangre", hard: "Zumbido", very_hard: "Verano" } },
                { word: "Mariposa", hints: { easy: "Alas", medium: "Colores", hard: "Oruga", very_hard: "Flor" } }
            ],
            profesiones: [
                { word: "Doctor", hints: { easy: "Salud", medium: "Hospital", hard: "Bata", very_hard: "Estetoscopio" } },
                { word: "Profesor", hints: { easy: "Escuela", medium: "Ense√±ar", hard: "Pizarra", very_hard: "Examen" } },
                { word: "Polic√≠a", hints: { easy: "Ley", medium: "Uniforme", hard: "Sirena", very_hard: "Multa" } },
                { word: "Bombero", hints: { easy: "Fuego", medium: "Manguera", hard: "Cami√≥n", very_hard: "Casco" } },
                { word: "Cocinero", hints: { easy: "Comida", medium: "Restaurante", hard: "Gorro", very_hard: "Sart√©n" } },
                { word: "Astronauta", hints: { easy: "Espacio", medium: "Luna", hard: "Cohete", very_hard: "Gravedad" } },
                { word: "Futbolista", hints: { easy: "Deporte", medium: "Bal√≥n", hard: "Gol", very_hard: "Estadio" } },
                { word: "Mec√°nico", hints: { easy: "Coche", medium: "Taller", hard: "Grasa", very_hard: "Herramientas" } },
                { word: "Peluquero", hints: { easy: "Pelo", medium: "Tijeras", hard: "Peinado", very_hard: "Espejo" } },
                { word: "Piloto", hints: { easy: "Avi√≥n", medium: "Volar", hard: "Uniforme", very_hard: "Aeropuerto" } },
                { word: "Jardinero", hints: { easy: "Plantas", medium: "Verde", hard: "Tierra", very_hard: "Regar" } },
                { word: "Camarero", hints: { easy: "Bar", medium: "Bandeja", hard: "Propina", very_hard: "Pedido" } },
                { word: "Juez", hints: { easy: "Ley", medium: "Mazo", hard: "Juicio", very_hard: "Toga" } },
                { word: "Pintor", hints: { easy: "Cuadro", medium: "Brocha", hard: "Color", very_hard: "Pared" } },
                { word: "Cantante", hints: { easy: "M√∫sica", medium: "Micr√≥fono", hard: "Voz", very_hard: "Escenario" } },
                { word: "Actor", hints: { easy: "Pel√≠cula", medium: "Famoso", hard: "Papel", very_hard: "Teatro" } },
                { word: "Payaso", hints: { easy: "Circo", medium: "Risa", hard: "Nariz roja", very_hard: "Maquillaje" } },
                { word: "Mago", hints: { easy: "Truco", medium: "Conejo", hard: "Sombrero", very_hard: "Carta" } },
                { word: "Soldado", hints: { easy: "Ej√©rcito", medium: "Guerra", hard: "Arma", very_hard: "Uniforme" } },
                { word: "Cura", hints: { easy: "Iglesia", medium: "Misa", hard: "Sotana", very_hard: "Dios" } },
                { word: "Periodista", hints: { easy: "Noticia", medium: "Micr√≥fono", hard: "Entrevista", very_hard: "Peri√≥dico" } },
                { word: "Fot√≥grafo", hints: { easy: "C√°mara", medium: "Foto", hard: "Flash", very_hard: "Retrato" } },
                { word: "Carpintero", hints: { easy: "Madera", medium: "Mueble", hard: "Sierra", very_hard: "Martillo" } },
                { word: "Fontanero", hints: { easy: "Agua", medium: "Tuber√≠a", hard: "Grifo", very_hard: "Fuga" } },
                { word: "Electricista", hints: { easy: "Luz", medium: "Cable", hard: "Chispa", very_hard: "Enchufe" } },
                { word: "Cartero", hints: { easy: "Carta", medium: "Buz√≥n", hard: "Paquete", very_hard: "Correo" } },
                { word: "Dentista", hints: { easy: "Dientes", medium: "Dolor", hard: "Silla", very_hard: "Sonrisa" } },
                { word: "Veterinario", hints: { easy: "Animales", medium: "M√©dico", hard: "Perro", very_hard: "Cl√≠nica" } },
                { word: "Alba√±il", hints: { easy: "Obra", medium: "Ladrillo", hard: "Cemento", very_hard: "Casa" } },
                { word: "Cient√≠fico", hints: { easy: "Laboratorio", medium: "Bata", hard: "Experimento", very_hard: "F√≥rmula" } }
            ],
            deportes: [
                { word: "F√∫tbol", hints: { easy: "Bal√≥n", medium: "Gol", hard: "Once", very_hard: "Porter√≠a" } },
                { word: "Baloncesto", hints: { easy: "Canasta", medium: "Alto", hard: "Naranja", very_hard: "NBA" } },
                { word: "Tenis", hints: { easy: "Raqueta", medium: "Red", hard: "Nadal", very_hard: "Set" } },
                { word: "Nataci√≥n", hints: { easy: "Agua", medium: "Piscina", hard: "Nadar", very_hard: "Estilos" } },
                { word: "Atletismo", hints: { easy: "Correr", medium: "Pista", hard: "Juegos Ol√≠mpicos", very_hard: "Velocidad" } },
                { word: "Boxeo", hints: { easy: "Golpe", medium: "Ring", hard: "Guantes", very_hard: "Asalto" } },
                { word: "Ciclismo", hints: { easy: "Bici", medium: "Tour", hard: "Casco", very_hard: "Pedalear" } },
                { word: "Golf", hints: { easy: "Hoyo", medium: "Palo", hard: "Verde", very_hard: "Caddy" } },
                { word: "Voleibol", hints: { easy: "Red", medium: "Playa", hard: "Mano", very_hard: "Salto" } },
                { word: "Rugby", hints: { easy: "Placaje", medium: "Mel√©", hard: "Bal√≥n ovalado", very_hard: "Ensayo" } },
                { word: "B√©isbol", hints: { easy: "Bate", medium: "Home run", hard: "Gorra", very_hard: "Base" } },
                { word: "Esqu√≠", hints: { easy: "Nieve", medium: "Monta√±a", hard: "Bastones", very_hard: "Descenso" } },
                { word: "F√≥rmula 1", hints: { easy: "Coche", medium: "Carrera", hard: "Circuito", very_hard: "Motor" } },
                { word: "Surf", hints: { easy: "Ola", medium: "Tabla", hard: "Mar", very_hard: "Equilibrio" } },
                { word: "Karate", hints: { easy: "Artes marciales", medium: "Cintur√≥n", hard: "Kimono", very_hard: "Dojo" } },
                { word: "Ping Pong", hints: { easy: "Mesa", medium: "Pala", hard: "China", very_hard: "Red" } },
                { word: "B√°dminton", hints: { easy: "Pluma", medium: "Raqueta", hard: "Red", very_hard: "Ligero" } },
                { word: "Hockey", hints: { easy: "Stick", medium: "Hielo", hard: "Pastilla", very_hard: "Patines" } },
                { word: "P√°del", hints: { easy: "Cristal", medium: "Pareja", hard: "Pala", very_hard: "Pared" } },
                { word: "Gimnasia", hints: { easy: "Flexible", medium: "Juegos", hard: "Aro", very_hard: "Suelo" } },
                { word: "Escalada", hints: { easy: "Roca", medium: "Altura", hard: "Cuerda", very_hard: "Arn√©s" } },
                { word: "Patinaje", hints: { easy: "Ruedas", medium: "Suelo", hard: "Deslizar", very_hard: "Casco" } },
                { word: "Balonmano", hints: { easy: "Mano", medium: "Porter√≠a", hard: "Siete", very_hard: "Cancha" } },
                { word: "Waterpolo", hints: { easy: "Piscina", medium: "Bal√≥n", hard: "Gorro", very_hard: "Flotar" } },
                { word: "Judo", hints: { easy: "Llave", medium: "Tatami", hard: "Jap√≥n", very_hard: "Agarre" } },
                { word: "Esgrima", hints: { easy: "Espada", medium: "M√°scara", hard: "Blanco", very_hard: "Tocado" } },
                { word: "Tiro con arco", hints: { easy: "Flecha", medium: "Diana", hard: "Punter√≠a", very_hard: "Robin Hood" } },
                { word: "Bolos", hints: { easy: "Strike", medium: "Bola", hard: "Diez", very_hard: "Zapatos" } },
                { word: "Billar", hints: { easy: "Taco", medium: "Bolas", hard: "Mesa verde", very_hard: "Agujero" } },
                { word: "Ajedrez", hints: { easy: "Tablero", medium: "Rey", hard: "Estrategia", very_hard: "Jaque" } }
            ],
            instrumentos: [
                { word: "Guitarra", hints: { easy: "Cuerdas", medium: "Tocar", hard: "Espa√±ola", very_hard: "P√∫a" } },
                { word: "Piano", hints: { easy: "Teclas", medium: "Blanco y negro", hard: "Cola", very_hard: "Pedal" } },
                { word: "Bater√≠a", hints: { easy: "Baquetas", medium: "Ritmo", hard: "Platillo", very_hard: "Ruido" } },
                { word: "Viol√≠n", hints: { easy: "Arco", medium: "Cuello", hard: "Orquesta", very_hard: "Agudo" } },
                { word: "Trompeta", hints: { easy: "Viento", medium: "Dorado", hard: "Jazz", very_hard: "Boquilla" } },
                { word: "Flauta", hints: { easy: "Soplar", medium: "Agujeros", hard: "Colegio", very_hard: "Dulce" } },
                { word: "Saxof√≥n", hints: { easy: "Jazz", medium: "Dorado", hard: "Curvo", very_hard: "Lisa Simpson" } },
                { word: "Acorde√≥n", hints: { easy: "Fuelle", medium: "Teclas", hard: "Pecho", very_hard: "Aire" } },
                { word: "Arpa", hints: { easy: "√Ångel", medium: "Cuerdas", hard: "Grande", very_hard: "Dedos" } },
                { word: "Ukelele", hints: { easy: "Peque√±o", medium: "Hawai", hard: "Cuatro cuerdas", very_hard: "Guitarra" } },
                { word: "Maracas", hints: { easy: "Agitar", medium: "Par", hard: "Ritmo", very_hard: "Salsa" } },
                { word: "Pandereta", hints: { easy: "Golpear", medium: "Cascabeles", hard: "Navidad", very_hard: "Mano" } },
                { word: "Xil√≥fono", hints: { easy: "Golpear", medium: "Madera", hard: "Escala", very_hard: "Mazo" } },
                { word: "Gaita", hints: { easy: "Escocia", medium: "Soplar", hard: "Falda", very_hard: "Aire" } },
                { word: "Clarinete", hints: { easy: "Negro", medium: "Viento", hard: "Calamardo", very_hard: "Madera" } },
                { word: "Tromb√≥n", hints: { easy: "Vara", medium: "Estirar", hard: "Metal", very_hard: "Largo" } },
                { word: "Bajo", hints: { easy: "Grave", medium: "Cuatro cuerdas", hard: "Ritmo", very_hard: "El√©ctrico" } },
                { word: "Arm√≥nica", hints: { easy: "Boca", medium: "Bolsillo", hard: "Blues", very_hard: "Metal" } },
                { word: "Tri√°ngulo", hints: { easy: "Metal", medium: "Geometr√≠a", hard: "Tintineo", very_hard: "Orquesta" } },
                { word: "Bombo", hints: { easy: "Grande", medium: "Grave", hard: "Tambor", very_hard: "Mazo" } },
                { word: "Platillos", hints: { easy: "Chocar", medium: "Metal", hard: "Ruido", very_hard: "Pares" } },
                { word: "Casta√±uelas", hints: { easy: "Manos", medium: "Espa√±a", hard: "Flamenco", very_hard: "Madera" } },
                { word: "Violonchelo", hints: { easy: "Sentado", medium: "Grande", hard: "Suelo", very_hard: "Grave" } },
                { word: "Tuba", hints: { easy: "Gigante", medium: "Grave", hard: "Metal", very_hard: "Viento" } },
                { word: "Oboe", hints: { easy: "Viento", medium: "Madera", hard: "Doble ca√±a", very_hard: "Orquesta" } },
                { word: "Banjo", hints: { easy: "Redondo", medium: "Country", hard: "Cuerdas", very_hard: "Am√©rica" } },
                { word: "Sitar", hints: { easy: "India", medium: "Cuerdas", hard: "Suelo", very_hard: "Ex√≥tico" } },
                { word: "Gong", hints: { easy: "Chino", medium: "Golpe", hard: "Disco", very_hard: "Suspenso" } },
                { word: "Bongo", hints: { easy: "Tambor", medium: "Manos", hard: "Pareja", very_hard: "Cuba" } },
                { word: "Micr√≥fono", hints: { easy: "Voz", medium: "Cantar", hard: "Amplificar", very_hard: "Karaoke" } }
            ],
            ropa: [
                { word: "Camiseta", hints: { easy: "Manga", medium: "Algod√≥n", hard: "Verano", very_hard: "Torso" } },
                { word: "Pantal√≥n", hints: { easy: "Piernas", medium: "Largo", hard: "Vaquero", very_hard: "Cintura" } },
                { word: "Zapatos", hints: { easy: "Pies", medium: "Suela", hard: "Cordones", very_hard: "Caminar" } },
                { word: "Calcetines", hints: { easy: "Pies", medium: "Par", hard: "Interior", very_hard: "Olor" } },
                { word: "Gorra", hints: { easy: "Cabeza", medium: "Sol", hard: "Visera", very_hard: "Deporte" } },
                { word: "Bufanda", hints: { easy: "Cuello", medium: "Invierno", hard: "Lana", very_hard: "Larga" } },
                { word: "Guantes", hints: { easy: "Manos", medium: "Fr√≠o", hard: "Dedos", very_hard: "Par" } },
                { word: "Abrigo", hints: { easy: "Fr√≠o", medium: "Invierno", hard: "Grueso", very_hard: "Botones" } },
                { word: "Vestido", hints: { easy: "Mujer", medium: "Una pieza", hard: "Falda", very_hard: "Elegante" } },
                { word: "Falda", hints: { easy: "Piernas", medium: "Mujer", hard: "Vuelo", very_hard: "Corta/Larga" } },
                { word: "Corbata", hints: { easy: "Cuello", medium: "Traje", hard: "Nudo", very_hard: "Formal" } },
                { word: "Cintur√≥n", hints: { easy: "Cintura", medium: "Ajustar", hard: "Hebilla", very_hard: "Cuero" } },
                { word: "Ba√±ador", hints: { easy: "Agua", medium: "Playa", hard: "Nadar", very_hard: "Verano" } },
                { word: "Pijama", hints: { easy: "Dormir", medium: "Cama", hard: "Noche", very_hard: "C√≥modo" } },
                { word: "Zapatillas", hints: { easy: "Deporte", medium: "C√≥modo", hard: "Cordones", very_hard: "Correr" } },
                { word: "Chanclas", hints: { easy: "Verano", medium: "Dedo", hard: "Playa", very_hard: "Suela" } },
                { word: "Gafas", hints: { easy: "Ojos", medium: "Ver", hard: "Sol", very_hard: "Cristal" } },
                { word: "Reloj", hints: { easy: "Mu√±eca", medium: "Tiempo", hard: "Hora", very_hard: "Tic-tac" } },
                { word: "Anillo", hints: { easy: "Dedo", medium: "Joya", hard: "Boda", very_hard: "Oro" } },
                { word: "Collar", hints: { easy: "Cuello", medium: "Joya", hard: "Colgante", very_hard: "Perlas" } },
                { word: "Sudadera", hints: { easy: "Capucha", medium: "Deporte", hard: "Algod√≥n", very_hard: "Informal" } },
                { word: "Chaqueta", hints: { easy: "Cremallera", medium: "Abrir", hard: "Manga", very_hard: "Cuero" } },
                { word: "Botas", hints: { easy: "Lluvia", medium: "Alto", hard: "Invierno", very_hard: "Pisada" } },
                { word: "Sombrero", hints: { easy: "Cabeza", medium: "Ala", hard: "Elegante", very_hard: "Sol" } },
                { word: "Traje", hints: { easy: "Boda", medium: "Elegante", hard: "Chaqueta", very_hard: "Negocios" } },
                { word: "Bata", hints: { easy: "Casa", medium: "Ducha", hard: "M√©dico", very_hard: "Cintur√≥n" } },
                { word: "Chaleco", hints: { easy: "Sin mangas", medium: "Torso", hard: "Fr√≠o", very_hard: "Debajo" } },
                { word: "Tacones", hints: { easy: "Alto", medium: "Mujer", hard: "Elegante", very_hard: "Ruido" } },
                { word: "Mascarilla", hints: { easy: "Boca", medium: "Virus", hard: "Goma", very_hard: "Protecci√≥n" } },
                { word: "Mochila", hints: { easy: "Espalda", medium: "Cargar", hard: "Escuela", very_hard: "Cierre" } }
            ]
        };

    function toggleTheme() {
        const checkbox = document.getElementById('checkbox-theme');
        if(checkbox.checked) {
            document.body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
        } else {
            document.body.classList.remove('light-mode');
            localStorage.setItem('theme', 'dark');
        }
    }
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { document.body.classList.add('light-mode'); document.getElementById('checkbox-theme').checked = true; }

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.getElementById('review-overlay').style.display = 'none';
    }

    function exitGame() {
        if(confirm("¬øSeguro que quieres salir de la sala?")) {
            if(roomId && myId) { db.ref('rooms/' + roomId + '/players/' + myId).remove(); }
            window.location.reload();
        }
    }

    function createRoom() {
        const name = document.getElementById('player-name-input').value.trim();
        if (!name) return alert("Escribe tu nombre.");
        myName = name; isHost = true;
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const initialSettings = { imposterCount: "1", category: "random", difficulty: "medium" };
        db.ref('rooms/' + roomId).set({ status: 'lobby', settings: initialSettings, createdAt: firebase.database.ServerValue.TIMESTAMP }).then(() => { joinGameLogic(); });
    }

    function joinRoom() {
        const name = document.getElementById('player-name-input').value.trim();
        const code = document.getElementById('room-code-input').value.trim().toUpperCase();
        if (!name) return alert("Escribe tu nombre.");
        if (!code) return alert("Escribe el c√≥digo.");
        myName = name; roomId = code; isHost = false;
        db.ref('rooms/' + roomId).once('value', snapshot => {
            if (snapshot.exists()) { joinGameLogic(); } else { alert("Sala no encontrada."); }
        });
    }

    function joinGameLogic() {
        const playerRef = db.ref('rooms/' + roomId + '/players').push();
        myId = playerRef.key; localStorage.setItem('impostor_myId', myId);
        playerRef.onDisconnect().remove();
        playerRef.set({ name: myName, isHost: isHost }).then(() => { enterLobbyUI(); listenToRoom(); }).catch(err => { alert("Error: " + err.message); });
    }

    function enterLobbyUI() {
        switchScreen('lobby-screen');
        document.getElementById('display-room-code').innerText = roomId;
        updateUIForHost();
    }

    function syncSettings() {
        if (!isHost) return;
        const settings = {
            imposterCount: document.getElementById('imposter-count').value,
            category: document.getElementById('category-select').value,
            difficulty: document.getElementById('difficulty-select').value
        };
        db.ref('rooms/' + roomId + '/settings').set(settings);
    }

    function updateUIForHost() {
        const selects = ['imposter-count', 'category-select', 'difficulty-select'];
        const startBtn = document.getElementById('btn-start-game');
        const waitMsg = document.getElementById('waiting-msg');
        const statusText = document.getElementById('settings-status-text');
        const gameControls = document.getElementById('host-game-controls');
        const restartControls = document.getElementById('host-restart-controls');
        const restartWait = document.getElementById('waiting-restart');

        if (isHost) {
            selects.forEach(id => document.getElementById(id).disabled = false);
            startBtn.style.display = 'block'; waitMsg.style.display = 'none'; statusText.innerText = "(T√∫ eres el anfitri√≥n)";
            if(document.getElementById('game-screen').classList.contains('active')) gameControls.style.display = 'block';
            if(document.getElementById('result-screen').classList.contains('active')) { restartControls.style.display = 'block'; restartWait.style.display = 'none'; }
        } else {
            selects.forEach(id => document.getElementById(id).disabled = true);
            startBtn.style.display = 'none'; waitMsg.style.display = 'block'; statusText.innerText = "(Solo lectura)";
            gameControls.style.display = 'none'; restartControls.style.display = 'none';
            if(document.getElementById('result-screen').classList.contains('active')) restartWait.style.display = 'block';
        }
    }

    function listenToRoom() {
        const roomRef = db.ref('rooms/' + roomId);
        roomRef.child('players').on('value', snapshot => {
            const list = document.getElementById('player-list-lobby'); list.innerHTML = ""; playersInRoom = [];
            let hostExists = false; let firstPlayerId = null;
            snapshot.forEach(child => {
                const p = child.val(); p.id = child.key;
                if (!firstPlayerId) firstPlayerId = p.id;
                if (p.isHost) hostExists = true;
                playersInRoom.push(p);
                const li = document.createElement('li'); li.className = 'lobby-player';
                li.innerHTML = `<span>${p.isHost ? '<span class="host-badge">HOST</span>' : 'üë§'} ${p.name}</span> ${p.id === myId ? '<span class="me-badge">T√ö</span>' : ''}`;
                list.appendChild(li);
            });
            if (!hostExists && playersInRoom.length > 0 && myId === firstPlayerId) {
                db.ref('rooms/' + roomId + '/players/' + myId).update({ isHost: true }); isHost = true;
            }
            const me = playersInRoom.find(p => p.id === myId);
            if (me) { isHost = me.isHost; updateUIForHost(); }
        });

        roomRef.child('settings').on('value', snapshot => {
            const settings = snapshot.val();
            if (settings) {
                document.getElementById('imposter-count').value = settings.imposterCount;
                document.getElementById('category-select').value = settings.category;
                document.getElementById('difficulty-select').value = settings.difficulty;
            }
        });

        roomRef.child('gameState').on('value', snapshot => {
            const state = snapshot.val();
            if (!state) return;
            if (state.phase === 'assigned') {
                if (state.roles && state.roles[myId]) {
                    mySavedRoleData = { ...state.roles[myId], categoryName: state.categoryName };
                    revealMyRole(mySavedRoleData);
                }
            } else if (state.phase === 'playing') {
                startLocalTimer(state.endTime, state.starterName);
            } else if (state.phase === 'finished') {
                showResults(state);
            } else if (state.phase === 'reset') {
                resetLocalGame();
            }
        });
    }

    function startGame() {
        if (!isHost) return;
        if (playersInRoom.length < 3) return alert("Se necesitan al menos 3 jugadores.");
        const imposterCount = parseInt(document.getElementById('imposter-count').value);
        if (playersInRoom.length <= imposterCount) return alert("Demasiados impostores.");
        const categoryKey = document.getElementById('category-select').value;
        const difficulty = document.getElementById('difficulty-select').value;

        let keys = Object.keys(database);
        if (categoryKey !== 'random') keys = [categoryKey];
        const chosenCat = keys[Math.floor(Math.random() * keys.length)];
        const items = database[chosenCat];
        const secretItem = items[Math.floor(Math.random() * items.length)];

        let indices = playersInRoom.map((_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        
        const impostorIndices = indices.slice(0, imposterCount);
        const starterIndex = Math.floor(Math.random() * playersInRoom.length);
        const starterName = playersInRoom[starterIndex].name;

        let rolesMap = {};
        let impostorNames = [];
        playersInRoom.forEach((p, i) => {
            let isImposter = impostorIndices.includes(i);
            if(isImposter) impostorNames.push(p.name);
            rolesMap[p.id] = {
                isImposter: isImposter,
                word: secretItem.word,
                hint: secretItem.hints[difficulty] || "Sin pista",
                showHint: difficulty !== 'none'
            };
        });

        db.ref('rooms/' + roomId + '/gameState').set({
            phase: 'assigned', categoryName: chosenCat.toUpperCase(), roles: rolesMap, impostorNames: impostorNames, secretWord: secretItem.word, starterName: starterName
        });
    }

    function confirmRoleSeen() {
        // Esta funci√≥n se llama al pulsar "Entendido, Ocultar"
        // Simplemente movemos al jugador a la pantalla de juego localmente
        // pero en "modo espera" hasta que el timer arranque de verdad.
        switchScreen('game-screen');
        // Ocultamos el timer hasta que el server diga que ha empezado
        document.getElementById('timer').innerText = "ESPERANDO...";
        document.getElementById('starter-name').innerText = "...";
        document.getElementById('waiting-others-msg').style.display = 'block'; // Mensaje de espera
        
        // Si somos el host, ahora enviamos la se√±al de start a todos
        if(isHost) {
             const now = Date.now();
             const duration = 180 * 1000; 
             db.ref('rooms/' + roomId + '/gameState').update({
                phase: 'playing',
                startTime: now,
                endTime: now + duration
            });
        }
    }

    function goToGame() {
        // Funci√≥n Legacy (ya no se usa directamente por el bot√≥n, pero se mantiene por compatibilidad)
        confirmRoleSeen();
    }

    function endGameGlobal() { db.ref('rooms/' + roomId + '/gameState').update({ phase: 'finished' }); }
    function returnToLobbyGlobal() { db.ref('rooms/' + roomId + '/gameState').set({ phase: 'reset' }); }

    function revealMyRole(data) {
        switchScreen('role-screen');
        const card = document.getElementById('role-card-display');
        const text = document.getElementById('role-text');
        const hint = document.getElementById('role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        if (data.isImposter) {
            card.classList.add('imposter-reveal'); text.innerText = "üïµÔ∏è IMPOSTOR";
            if (data.showHint) { hint.style.display = 'block'; hint.innerText = "Pista: " + data.hint; }
        } else { text.innerText = data.word; }
        document.getElementById('category-display').innerText = "Categor√≠a: " + data.categoryName;
    }

    function openRoleReview() {
        if (!mySavedRoleData) return;
        const card = document.getElementById('review-card-display');
        const text = document.getElementById('review-role-text');
        const hint = document.getElementById('review-role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        if (mySavedRoleData.isImposter) {
            card.classList.add('imposter-reveal'); text.innerText = "üïµÔ∏è IMPOSTOR";
            if (mySavedRoleData.showHint) { hint.style.display = 'block'; hint.innerText = "Pista: " + mySavedRoleData.hint; }
        } else { text.innerText = mySavedRoleData.word; }
        document.getElementById('review-category-display').innerText = "Categor√≠a: " + mySavedRoleData.categoryName;
        document.getElementById('review-overlay').style.display = 'flex';
    }

    function closeRoleReview() { document.getElementById('review-overlay').style.display = 'none'; }

    function startLocalTimer(endTime, starterName) {
        switchScreen('game-screen');
        // Ya ha empezado, quitamos mensajes de espera
        document.getElementById('waiting-others-msg').style.display = 'none';
        document.getElementById('starter-name').innerText = starterName;
        
        updateUIForHost();
        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const now = Date.now();
            const left = Math.max(0, Math.floor((endTime - now) / 1000));
            const m = Math.floor(left / 60).toString().padStart(2,'0');
            const s = (left % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            if (left <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "00:00";
                if (isHost) { endGameGlobal(); }
            }
        }, 1000);
    }

    function showResults(state) {
        clearInterval(timerInterval);
        switchScreen('result-screen');
        document.getElementById('result-impostors').innerText = state.impostorNames.join(" y ");
        document.getElementById('result-word').innerText = state.secretWord;
        updateUIForHost();
    }

    function resetLocalGame() { enterLobbyUI(); mySavedRoleData = null; }
</script>
</body>
</html>