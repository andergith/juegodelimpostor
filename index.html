<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Jugar Juego del Impostor Online - Adivina la Palabra Secreta</title>
    <meta name="description" content="La mejor web para jugar al juego del impostor online gratis con amigos o en persona. Un juego de deducci√≥n social, palabras y enga√±os sin descargar nada.">
    <meta name="keywords" content="jugar juego del impostor, jugar juego del impostor online, juego del impostor palabras, juego social online, juego multijugador navegador">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://tu-dominio-aqui.com/" /> <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-dominio-aqui.com/">
    <meta property="og:title" content="Jugar Juego del Impostor Online - Gratis">
    <meta property="og:description" content="Entra y descubre qui√©n es el esp√≠a. Juega al impostor con tus amigos desde el m√≥vil sin instalar nada.">
    <meta property="og:image" content="https://tu-dominio-aqui.com/imagen-preview.jpg"> <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Juego del Impostor Online",
      "applicationCategory": "Game",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      },
      "description": "Aplicaci√≥n web gratuita para jugar al juego del impostor online o local con amigos. Deducci√≥n social y palabras secretas."
    }
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --glass-bg: rgba(22, 33, 62, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #e94560;
            --text-main: #ffffff;
            --text-secondary: #bdc3c7;
            --btn-color: #0f3460;
            --danger-color: #ff4757;
            --success-color: #2ecc71;
            --whatsapp-color: #25D366;
            --input-bg: rgba(0, 0, 0, 0.5); 
            --option-bg: #000000;
            --option-text: #ffffff;
            --bg-gradient: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #1a1a2e);
        }

        body.light-mode {
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --accent-color: #ff6b6b;
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --btn-color: #54a0ff;
            --danger-color: #ff4757;
            --success-color: #1dd1a1;
            --input-bg: rgba(0, 0, 0, 0.05); 
            --option-bg: #ffffff;
            --option-text: #000000;
            --bg-gradient: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            overscroll-behavior-y: none;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: color 0.3s ease;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container {
            background-color: var(--glass-bg);
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            margin: 0 auto;
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        /* SEO Text Footer inside container */
        .seo-footer {
            margin-top: 25px;
            border-top: 1px solid var(--glass-border);
            padding-top: 15px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: left;
            line-height: 1.4;
        }
        .seo-footer h2 {
            font-size: 0.9rem;
            color: var(--accent-color);
            margin: 0 0 5px 0;
        }

        /* UTILS */
        #connection-status {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: var(--danger-color); color: white; 
            font-size: 0.8rem; padding: 5px; z-index: 9999; 
            display: none; font-weight: bold; text-align: center;
        }
        
        /* Toggle Theme */
        .theme-switch-wrapper { position: absolute; top: 25px; left: 20px; display: flex; align-items: center; z-index: 10; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: rgba(0,0,0,0.3); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; font-size: 14px; }
        .slider .icon { z-index: 1; pointer-events: none; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 20px; left: 4px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; z-index: 2; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        h1 { margin-bottom: 1rem; color: var(--accent-color); text-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 2.2rem; font-weight: 800; letter-spacing: -0.5px; margin-top: 10px; }
        .screen { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"], select {
            padding: 14px; border-radius: 14px; border: 1px solid var(--glass-border); 
            width: 100%; box-sizing: border-box; font-size: 16px; background: var(--input-bg); 
            color: var(--text-main); outline: none; transition: all 0.2s; appearance: none; -webkit-appearance: none;
        }
        input[type="text"]:focus, select:focus { background: rgba(125, 125, 125, 0.1); border-color: var(--accent-color); }
        select:disabled { opacity: 0.6; }
        select option { background-color: var(--option-bg); color: var(--option-text); }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23888888%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4-3.7%203.7-5.4%208-5.4%2013%200%205%201.8%209.3%205.4%2013l128%20128c3.7%203.7%208%205.4%2013%205.4s9.3-1.8%2013-5.4l128-128c3.7-3.7%205.4-8%205.4-13%200-5-1.8-9.3-5.4-13z%27%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 1em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        label { display: block; text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        button {
            background-color: var(--accent-color); color: white; border: none; padding: 16px 30px; 
            border-radius: 16px; font-size: 1.1rem; cursor: pointer; width: 100%; font-weight: 700;
            transition: transform 0.1s, opacity 0.2s; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.7; cursor: wait; }
        
        button.small-btn { width: auto; padding: 0 20px; margin: 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; }
        button.secondary { background-color: var(--btn-color); box-shadow: none; }
        button.danger { background-color: var(--danger-color); margin-top: 25px; }
        button.exit-btn { width: auto; padding: 5px 12px; font-size: 0.8rem; background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); margin: 0; box-shadow: none; }
        button.whatsapp-btn { background-color: var(--whatsapp-color); font-size: 0.9rem; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* Botones de Votaci√≥n */
        .vote-btn {
            background-color: var(--input-bg);
            border: 1px solid var(--glass-border);
            text-align: left;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vote-btn.selected {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .mode-btn { padding: 25px; font-size: 1.3rem; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .mode-subtext { font-size: 0.8rem; font-weight: normal; opacity: 0.8; }

        #player-list-lobby, #offline-player-list { list-style: none; padding: 0; margin: 10px 0; max-height: 20vh; overflow-y: auto; scrollbar-width: thin; }
        .lobby-player, .player-item { background: var(--input-bg); padding: 10px; margin: 5px 0; border-radius: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border); }
        .delete-btn { background: #ff7675; border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; box-shadow: none; }

        .me-badge { font-size: 0.7rem; background: var(--success-color); padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-left: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .host-badge { font-size: 0.7rem; background: #f1c40f; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-right: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .score-badge { font-size: 0.9rem; font-weight: bold; color: var(--accent-color); background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; }

        .role-card { background: var(--input-bg); color: var(--text-main); padding: 30px 20px; border-radius: 20px; margin: 20px 0; font-size: 2rem; font-weight: 800; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .imposter-reveal { background: rgba(255, 71, 87, 0.2); border: 1px solid var(--danger-color); color: var(--danger-color); }
        .hint-box { display: block; margin-top: 15px; font-size: 1rem; font-weight: 500; background: rgba(0,0,0,0.1); color: var(--text-main); padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; }
        
        #timer { font-size: 4rem; margin: 10px 0; font-weight: 800; color: var(--accent-color); font-family: 'Courier New', monospace; text-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .room-code-display { font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: var(--success-color); margin: 5px 0; background: var(--input-bg); padding: 5px; border-radius: 10px; }

        #review-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--glass-bg); z-index: 2000; padding: 20px; box-sizing: border-box; display: none; flex-direction: column; justify-content: center; align-items: center; border-radius: 24px; backdrop-filter: blur(20px); overflow-y: auto; }
        .close-icon-overlay { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; color: var(--text-main); cursor: pointer; z-index: 2001; font-weight: bold; line-height: 1; }
        
        .lobby-settings-box { border-top: 1px solid var(--glass-border); padding-top: 15px; margin-top: 10px; text-align: left; }
        .host-badge-settings { font-size: 0.7rem; color: var(--success-color); float: right; font-weight: normal; margin-top: 3px; }
        .header-game { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; min-height: 30px;}
        .lobby-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; }
        .score-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .score-btn-civ { background-color: var(--btn-color); font-size: 0.9rem; }
        .score-btn-imp { background-color: var(--danger-color); font-size: 0.9rem; margin-top: 0;}
    </style>
</head>
<body>

<div id="connection-status">‚ö†Ô∏è Sin conexi√≥n a internet</div>

<main class="container">
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox-theme" aria-label="Cambiar tema">
            <input type="checkbox" id="checkbox-theme" onchange="toggleTheme()">
            <div class="slider round">
                <span class="icon" style="margin-left: 4px;">üåô</span>
                <span class="icon" style="margin-right: 4px;">‚òÄÔ∏è</span>
            </div>
        </label>
    </div>

    <section id="mode-selection-screen" class="screen active">
        <h1>üïµÔ∏è Juego del Impostor</h1>
        <p style="opacity: 0.8; margin-bottom: 20px;">Elige tu modo para <strong>jugar al juego del impostor</strong>:</p>
        <button class="mode-btn" onclick="selectMode('offline')">
            üè† Jugar en Persona
            <span class="mode-subtext">1 solo m√≥vil (Pasar y jugar)</span>
        </button>
        <button class="mode-btn secondary" onclick="selectMode('online')">
            üåê Jugar Online
            <span class="mode-subtext">Multijugador a distancia</span>
        </button>

        <article class="seo-footer">
            <h2>¬øC√≥mo jugar al juego del impostor online?</h2>
            <p>Bienvenido al mejor sitio para <strong>jugar al juego del impostor online</strong> gratis. Esta herramienta te permite crear partidas privadas con tus amigos.</p>
            <p>Las reglas son simples: todos reciben una palabra secreta menos el impostor. Deb√©is debatir y votar para expulsarlo antes de que acabe el tiempo. ¬°Ideal para fiestas y videollamadas!</p>
        </article>
    </section>

    <div id="online-home-screen" class="screen">
        <div class="header-game"><button onclick="goBackToMode()" class="exit-btn">‚Üê Volver</button></div>
        <h2>Modo Online</h2>
        <input type="text" id="player-name-input" placeholder="Tu Nombre" maxlength="12" aria-label="Tu nombre">
        <div style="margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <button onclick="createRoom()" id="btn-create">üëë Crear Nueva Sala</button>
            <p style="margin: 15px 0; opacity: 0.7;">- O -</p>
            <input type="text" id="room-code-input" placeholder="C√≥digo de Sala" style="text-transform: uppercase;" aria-label="C√≥digo de sala">
            <button class="secondary" onclick="joinRoom()" id="btn-join">Entrar en Sala</button>
        </div>
    </div>

    <div id="offline-setup-screen" class="screen">
        <div class="header-game"><button onclick="goBackToMode()" class="exit-btn">‚Üê Volver</button></div>
        <h2>Modo Offline</h2>
        <label style="margin-top:0;">A√±adir Jugadores (min 3):</label>
        <div class="input-group">
            <input type="text" id="offline-new-player" placeholder="Ej: Ana" onkeypress="handleEnterOffline(event)" autocomplete="off">
            <button class="small-btn" onclick="addOfflinePlayer()">+</button>
        </div>
        <ul id="offline-player-list"></ul>
        <div class="lobby-settings-box">
            <label>CONFIGURACI√ìN</label>
            <select id="offline-imposter-count">
                <option value="random" selected>üé≤ Aleatorio (1 o 2)</option>
                <option value="1">1 Impostor</option>
                <option value="2">2 Impostores</option>
            </select>
            <select id="offline-category-select">
                <option value="random">üé≤ Categor√≠a Aleatoria</option>
                <option value="lugares">üåç Lugares</option>
                <option value="comida">üçï Comida</option>
                <option value="animales">üê∂ Animales</option>
                <option value="profesiones">üíº Profesiones</option>
                <option value="deportes">‚öΩ Deportes</option>
                <option value="instrumentos">üé∏ Instrumentos</option>
                <option value="ropa">üëï Ropa</option>
            </select>
            <select id="offline-difficulty-select">
                <option value="medium">üü° Pista Media</option>
                <option value="hard">üî¥ Pista Dif√≠cil</option>
                <option value="very_hard">üíÄ Pista Muy Dif√≠cil</option>
            </select>
            <button onclick="startOfflineGame()" class="btn-start-margin">Empezar Partida</button>
        </div>
    </div>

    <div id="offline-pass-screen" class="screen">
        <h2>Turno de:</h2>
        <span id="offline-current-player-display" style="font-size: 2rem; font-weight: bold; color: var(--accent-color); display: block; margin: 10px 0;">Jugador</span>
        <p style="opacity: 0.8; margin-bottom: 20px;">Pasa el dispositivo a <span id="offline-current-player-text"></span>.<br>Nadie m√°s debe mirar.</p>
        <div style="font-size: 5rem; margin: 30px 0; opacity: 0.8; animation: pulse 2s infinite;">üì±üñêÔ∏è</div>
        <button onclick="showOfflineRole()">Ver mi Rol</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-header">
            <button onclick="exitGame()" class="exit-btn">‚úï Salir</button>
        </div>
        <h2 style="font-size: 0.9rem; opacity: 0.7; margin-bottom:5px;">C√ìDIGO DE SALA:</h2>
        <div id="display-room-code" class="room-code-display">----</div>
        <button onclick="shareWhatsApp()" class="whatsapp-btn">üì± Compartir por WhatsApp</button>
        <p style="margin-bottom: 5px; opacity: 0.7; font-size: 0.9rem; margin-top: 20px;">Jugadores:</p>
        <ul id="player-list-lobby"></ul>
        <div class="lobby-settings-box">
            <label>CONFIGURACI√ìN <span id="settings-status-text" class="host-badge-settings"></span></label>
            <select id="imposter-count" onchange="syncSettings()">
                <option value="random" selected>üé≤ Aleatorio (1 o 2)</option>
                <option value="1">1 Impostor</option>
                <option value="2">2 Impostores</option>
            </select>
            <select id="category-select" onchange="syncSettings()">
                <option value="random">üé≤ Categor√≠a Aleatoria</option>
                <option value="lugares">üåç Lugares</option>
                <option value="comida">üçï Comida</option>
                <option value="animales">üê∂ Animales</option>
                <option value="profesiones">üíº Profesiones</option>
                <option value="deportes">‚öΩ Deportes</option>
                <option value="instrumentos">üé∏ Instrumentos</option>
                <option value="ropa">üëï Ropa</option>
            </select>
            <select id="difficulty-select" onchange="syncSettings()">
                <option value="medium">üü° Pista Media</option>
                <option value="hard">üî¥ Pista Dif√≠cil</option>
                <option value="very_hard">üíÄ Pista Muy Dif√≠cil</option>
            </select>
            <button id="btn-start-game" onclick="startGame()" style="display:none;">üöÄ EMPEZAR PARTIDA</button>
            <p id="waiting-msg" style="display:none; color: var(--success-color); animation: pulse 1.5s infinite; text-align: center; margin-top: 15px;">Esperando al anfitri√≥n...</p>
        </div>
    </div>

    <div id="role-screen" class="screen">
        <h2>Tu Rol</h2>
        <div id="role-card-display" class="role-card">
            <span id="role-text">...</span>
            <div id="role-hint" class="hint-box" style="display:none"></div>
        </div>
        <p id="category-display" style="opacity: 0.7;"></p>
        <button onclick="confirmRoleSeen()">Entendido, Ocultar</button>
    </div>

    <div id="game-screen" class="screen" style="position: relative;">
        <div class="header-game"><button onclick="exitGame()" class="exit-btn">‚úï Salir</button></div>
        <div id="review-overlay">
            <div class="close-icon-overlay" onclick="closeRoleReview()">‚úï</div>
            <h2 style="margin-bottom: 20px;">Tu Rol Secreto</h2>
            <div id="review-card-display" class="role-card" style="width: 100%;">
                <span id="review-role-text">...</span>
                <div id="review-role-hint" class="hint-box" style="display:none"></div>
            </div>
            <p id="review-category-display" style="opacity: 0.7;"></p>
            <button onclick="closeRoleReview()" class="secondary">Cerrar</button>
        </div>
        <div style="background: var(--input-bg); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--glass-border);">
            <p style="margin:0; font-size:0.8rem; opacity:0.7;">EMPIEZA HABLANDO:</p>
            <h2 id="starter-name" style="margin:5px 0;">?</h2>
        </div>
        <div id="timer">03:00</div>
        <button id="btn-review-role" onclick="openRoleReview()" class="secondary" style="font-size: 0.9rem; padding: 10px; margin-bottom: 20px;">üëÅÔ∏è Recordar mi palabra</button>
        <div id="host-game-controls" style="display:none;">
            <button class="danger" onclick="startVotingGlobal()">üö® RESOLVER / VOTAR</button>
        </div>
        <div id="offline-game-controls" style="display:none;">
            <button class="danger" onclick="endGameGlobal()">üö® RESOLVER</button>
        </div>
    </div>

    <div id="voting-screen" class="screen">
        <h2>üó≥Ô∏è Votaci√≥n</h2>
        <p style="opacity: 0.8; margin-bottom:15px;">Elige a qui√©n acusar:</p>
        <div id="voting-buttons-container"></div>
        <p id="vote-status" style="margin-top:20px; font-style:italic; opacity:0.7;"></p>
        
        <div id="host-voting-controls" style="display:none; margin-top:20px;">
            <button onclick="endGameGlobal()" class="small-btn" style="font-size:1rem; width:100%;">Forzar Resultados</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="header-game"><button onclick="exitGame()" class="exit-btn">‚úï Salir</button></div>
        <h2>FIN DE PARTIDA</h2>
        
        <div id="voting-results-display" style="display:none; margin-bottom:20px; background: rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
            <h3 style="font-size:1rem; margin-top:0;">Resultados Votaci√≥n:</h3>
            <ul id="votes-list" style="list-style:none; padding:0; text-align:left; font-size:0.9rem;"></ul>
        </div>

        <div style="background: var(--input-bg); padding: 20px; border-radius: 15px; border: 2px solid var(--accent-color);">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">IMPOSTOR(ES):</p>
            <div id="result-impostors" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-color); margin: 10px 0;">-</div>
            <hr style="border-color: var(--glass-border)">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">PALABRA SECRETA:</p>
            <div id="result-word" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-top: 5px;">-</div>
        </div>
        
        <div id="host-score-controls" style="display:none; margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 15px;">
            <p style="font-size: 0.9rem; margin-bottom: 10px;">¬øQUI√âN GAN√ì?</p>
            <div class="score-btn-group">
                <button class="score-btn-civ" onclick="distributePoints('civilians')">üòá Ciudadanos (+1)</button>
                <button class="score-btn-imp" onclick="distributePoints('impostors')">üòà Impostor (+3)</button>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 10px;">(Esto reiniciar√° la partida)</p>
        </div>

        <div id="host-restart-controls" style="display:none;">
            <button onclick="returnToLobbyGlobal()" style="background:transparent; border:1px solid var(--glass-border); font-size:0.8rem; margin-top:10px;">Reiniciar sin puntuar</button>
        </div>
        
        <div id="client-wait-restart" style="display:none; margin-top:20px;">
            <p id="waiting-restart" style="animation: pulse 1.5s infinite;">Esperando al anfitri√≥n...</p>
        </div>
        
        <button id="offline-restart-btn" onclick="resetOfflineGame()" style="display:none; margin-top:20px;">üîÑ VOLVER AL MENU</button>
    </div>
</main>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCD9EZAZldGoBHv5-v9jQ8wfOSVPL9mu60",
        authDomain: "juego-del-impostor-9318e.firebaseapp.com",
        databaseURL: "https://juego-del-impostor-9318e-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juego-del-impostor-9318e",
        storageBucket: "juego-del-impostor-9318e.firebasestorage.app",
        messagingSenderId: "952474577416",
        appId: "1:952474577416:web:3b13fa3169b12114787fbd",
        measurementId: "G-704F1P5P2J"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", (snap) => {
        const banner = document.getElementById('connection-status');
        if (snap.val() === true) banner.style.display = 'none'; else banner.style.display = 'block';
    });

    async function requestWakeLock() { if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); } } }

    // --- VARIABLES ---
    let CURRENT_MODE = ''; 
    let myName = "";
    let myId = localStorage.getItem('impostor_myId') || ""; 
    let roomId = "";
    let isHost = false;
    let playersInRoom = [];
    let offlinePlayers = [];
    let currentOfflineIndex = 0;
    let timerInterval;
    let mySavedRoleData = null; 
    let currentGameState = null;
    let hasVoted = false; // Control de votaci√≥n local

    const database = {
        lugares: [
            { word: "Playa", hints: { medium: "Arena", hard: "Sal", very_hard: "Marea" } },
            { word: "Hospital", hints: { medium: "Silencio", hard: "Bata", very_hard: "Guardia" } },
            { word: "Escuela", hints: { medium: "Pizarra", hard: "Recreo", very_hard: "Septiembre" } },
            { word: "Cine", hints: { medium: "Palomitas", hard: "Butaca", very_hard: "Estreno" } },
            { word: "Supermercado", hints: { medium: "Carrito", hard: "Pasillo", very_hard: "Bolsa" } },
            { word: "Avi√≥n", hints: { medium: "Nubes", hard: "Maleta", very_hard: "Pasaporte" } },
            { word: "Zool√≥gico", hints: { medium: "Jaula", hard: "Safari", very_hard: "Domingo" } }
        ],
        comida: [
            { word: "Pizza", hints: { medium: "Italia", hard: "Caja", very_hard: "Tri√°ngulo" } },
            { word: "Sushi", hints: { medium: "Jap√≥n", hard: "Palillos", very_hard: "Crudo" } },
            { word: "Hamburguesa", hints: { medium: "Pan", hard: "Ketchup", very_hard: "R√°pida" } },
            { word: "Helado", hints: { medium: "Verano", hard: "Derrite", very_hard: "Cuchara" } },
            { word: "Chocolate", hints: { medium: "Suiza", hard: "Tableta", very_hard: "Amargo" } },
            { word: "Ensalada", hints: { medium: "Dieta", hard: "Aceite", very_hard: "Mezclar" } }
        ],
        animales: [
            { word: "Perro", hints: { medium: "Amigo", hard: "Hueso", very_hard: "Correa" } },
            { word: "Gato", hints: { medium: "Bigotes", hard: "Siete vidas", very_hard: "Arena" } },
            { word: "Le√≥n", hints: { medium: "Selva", hard: "Melena", very_hard: "Rugido" } },
            { word: "Elefante", hints: { medium: "Circo", hard: "Man√≠", very_hard: "Pesado" } },
            { word: "Tibur√≥n", hints: { medium: "Sangre", hard: "Terror", very_hard: "Surfista" } },
            { word: "Ping√ºino", hints: { medium: "Traje", hard: "Huevo", very_hard: "Baile" } }
        ],
        deportes: [
            { word: "F√∫tbol", hints: { medium: "Gol", hard: "Once", very_hard: "Porter√≠a" } },
            { word: "Baloncesto", hints: { medium: "Alto", hard: "Naranja", very_hard: "NBA" } },
            { word: "Tenis", hints: { medium: "Red", hard: "Wimbledon", very_hard: "Ventaja" } }
        ],
        instrumentos: [
            { word: "Guitarra", hints: { medium: "Cuerdas", hard: "P√∫a", very_hard: "Traste" } },
            { word: "Piano", hints: { medium: "Teclas", hard: "Cola", very_hard: "Pedal" } },
            { word: "Bater√≠a", hints: { medium: "Ritmo", hard: "Platillos", very_hard: "Ruido" } }
        ],
        ropa: [
            { word: "Camiseta", hints: { medium: "Algod√≥n", hard: "Manga", very_hard: "Cuello" } },
            { word: "Pantal√≥n", hints: { medium: "Piernas", hard: "Cintur√≥n", very_hard: "Bolsillos" } },
            { word: "Zapatos", hints: { medium: "Suela", hard: "Cordones", very_hard: "Caminar" } }
        ]
    };

    function toggleTheme() {
        const checkbox = document.getElementById('checkbox-theme');
        if(checkbox.checked) { document.body.classList.add('light-mode'); localStorage.setItem('theme', 'light'); }
        else { document.body.classList.remove('light-mode'); localStorage.setItem('theme', 'dark'); }
    }
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { document.body.classList.add('light-mode'); document.getElementById('checkbox-theme').checked = true; }

    function shareWhatsApp() {
        const url = window.location.href;
        const message = `üïµÔ∏è ¬°√önete a la partida!\nüîó ${url}\nüîë C√≥digo: *${roomId}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.getElementById('review-overlay').style.display = 'none';
        if(screenId === 'game-screen') requestWakeLock();
    }

    function selectMode(mode) {
        CURRENT_MODE = mode;
        if(mode === 'online') switchScreen('online-home-screen');
        else switchScreen('offline-setup-screen');
    }

    function goBackToMode() {
        switchScreen('mode-selection-screen');
        if (roomId && myId && CURRENT_MODE === 'online') { db.ref('rooms/' + roomId + '/players/' + myId).remove(); }
        roomId = "";
    }

    function disableButton(btnId) {
        const btn = document.getElementById(btnId);
        if(btn) btn.disabled = true;
        setTimeout(() => { if(btn) btn.disabled = false; }, 2000); 
    }

    // --- ONLINE ---
    function createRoom() {
        disableButton('btn-create');
        const name = document.getElementById('player-name-input').value.trim().replace(/[.<>$]/g, ""); 
        if (!name) return alert("Escribe tu nombre.");
        myName = name; isHost = true;
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const initialSettings = { imposterCount: "random", category: "random", difficulty: "medium" };
        db.ref('rooms/' + roomId).set({ status: 'lobby', settings: initialSettings, createdAt: firebase.database.ServerValue.TIMESTAMP }).then(() => { joinGameLogic(); });
    }

    function joinRoom() {
        disableButton('btn-join');
        const name = document.getElementById('player-name-input').value.trim().replace(/[.<>$]/g, "");
        const code = document.getElementById('room-code-input').value.trim().toUpperCase().replace(/\s/g, '');
        if (!name) return alert("Escribe tu nombre.");
        if (!code) return alert("Escribe el c√≥digo.");
        myName = name; roomId = code; isHost = false;
        db.ref('rooms/' + roomId).once('value', snapshot => {
            if (snapshot.exists()) { joinGameLogic(); } else { alert("Sala no encontrada."); }
        });
    }

    function joinGameLogic() {
        const playerRef = db.ref('rooms/' + roomId + '/players').push();
        myId = playerRef.key; localStorage.setItem('impostor_myId', myId);
        playerRef.onDisconnect().remove();
        playerRef.set({ name: myName, isHost: isHost, score: 0 }).then(() => { enterLobbyUI(); listenToRoom(); }).catch(err => { alert("Error: " + err.message); });
    }

    function enterLobbyUI() {
        switchScreen('lobby-screen');
        document.getElementById('display-room-code').innerText = roomId;
        updateUIForHost();
    }

    function syncSettings() {
        if (!isHost || CURRENT_MODE === 'offline') return;
        const settings = {
            imposterCount: document.getElementById('imposter-count').value,
            category: document.getElementById('category-select').value,
            difficulty: document.getElementById('difficulty-select').value
        };
        db.ref('rooms/' + roomId + '/settings').set(settings);
    }

    function updateUIForHost() {
        if (CURRENT_MODE === 'offline') return;
        const selects = ['imposter-count', 'category-select', 'difficulty-select'];
        const startBtn = document.getElementById('btn-start-game');
        const waitMsg = document.getElementById('waiting-msg');
        const statusText = document.getElementById('settings-status-text');
        
        const gameControls = document.getElementById('host-game-controls');
        const voteControls = document.getElementById('host-voting-controls'); // Nuevo
        const scoreControls = document.getElementById('host-score-controls');
        const restartControls = document.getElementById('host-restart-controls');
        const clientWait = document.getElementById('client-wait-restart');

        if (isHost) {
            selects.forEach(id => document.getElementById(id).disabled = false);
            startBtn.style.display = 'block'; waitMsg.style.display = 'none'; statusText.innerText = "(T√∫ eres el anfitri√≥n)";
            if(document.getElementById('game-screen').classList.contains('active')) gameControls.style.display = 'block';
            if(document.getElementById('voting-screen').classList.contains('active')) voteControls.style.display = 'block';
            if(document.getElementById('result-screen').classList.contains('active')) { scoreControls.style.display = 'block'; restartControls.style.display = 'block'; clientWait.style.display = 'none'; }
        } else {
            selects.forEach(id => document.getElementById(id).disabled = true);
            startBtn.style.display = 'none'; waitMsg.style.display = 'block'; statusText.innerText = "(Solo lectura)";
            gameControls.style.display = 'none'; voteControls.style.display = 'none'; scoreControls.style.display = 'none'; restartControls.style.display = 'none';
            if(document.getElementById('result-screen').classList.contains('active')) clientWait.style.display = 'block';
        }
    }

    function listenToRoom() {
        const roomRef = db.ref('rooms/' + roomId);
        
        roomRef.child('players').on('value', snapshot => {
            const list = document.getElementById('player-list-lobby'); list.innerHTML = ""; playersInRoom = [];
            let hostExists = false; let firstPlayerId = null;
            snapshot.forEach(child => {
                const p = child.val(); p.id = child.key;
                if (!firstPlayerId) firstPlayerId = p.id;
                if (p.isHost) hostExists = true;
                playersInRoom.push(p);
                const li = document.createElement('li'); li.className = 'lobby-player';
                li.innerHTML = `<span>${p.isHost ? '<span class="host-badge">HOST</span>' : 'üë§'} ${p.name} ${p.id === myId ? '<span class="me-badge">T√ö</span>' : ''}</span> <span class="score-badge">${p.score || 0} pts</span>`;
                list.appendChild(li);
            });
            if (!hostExists && playersInRoom.length > 0 && myId === firstPlayerId) {
                db.ref('rooms/' + roomId + '/players/' + myId).update({ isHost: true }); isHost = true;
            }
            const me = playersInRoom.find(p => p.id === myId);
            if (me) { isHost = me.isHost; updateUIForHost(); }
        });

        roomRef.child('settings').on('value', snapshot => {
            const settings = snapshot.val();
            if (settings) {
                document.getElementById('imposter-count').value = settings.imposterCount;
                document.getElementById('category-select').value = settings.category;
                document.getElementById('difficulty-select').value = settings.difficulty;
            }
        });

        roomRef.child('gameState').on('value', snapshot => {
            const state = snapshot.val();
            if (!state) return;
            currentGameState = state;

            if (state.phase === 'assigned') {
                if (state.roles && state.roles[myId]) {
                    mySavedRoleData = { ...state.roles[myId], categoryName: state.categoryName };
                    revealMyRole(mySavedRoleData);
                } else {
                    document.getElementById('role-text').innerText = "Sincronizando...";
                    setTimeout(() => {}, 500); // Retry delay
                }
            } else if (state.phase === 'playing') {
                startLocalTimer(state.endTime, state.starterName);
            } else if (state.phase === 'voting') {
                showVotingScreen();
            } else if (state.phase === 'finished') {
                showResults(state);
            } else if (state.phase === 'reset') {
                resetLocalGame();
            }
        });
    }

    function startGame() {
        if (!isHost) return;
        if (playersInRoom.length < 3) return alert("Se necesitan al menos 3 jugadores.");
        const categoryKey = document.getElementById('category-select').value;
        const difficulty = document.getElementById('difficulty-select').value;
        const imposterSetting = document.getElementById('imposter-count').value;
        startSharedGameLogic(playersInRoom, imposterSetting, categoryKey, difficulty);
    }

    // --- VOTACI√ìN ONLINE ---
    function startVotingGlobal() {
        db.ref('rooms/' + roomId + '/gameState').update({ phase: 'voting' });
    }

    function showVotingScreen() {
        clearInterval(timerInterval); // Parar el timer
        switchScreen('voting-screen');
        hasVoted = false;
        document.getElementById('vote-status').innerText = "Toca un nombre para acusar:";
        
        const container = document.getElementById('voting-buttons-container');
        container.innerHTML = "";

        // Crear botones de votaci√≥n para cada jugador
        playersInRoom.forEach(p => {
            // No puedes votarte a ti mismo (opcional, pero com√∫n)
            if (p.id === myId) return;

            const btn = document.createElement('button');
            btn.className = 'vote-btn';
            btn.innerHTML = `<span>üë§ ${p.name}</span>`;
            btn.onclick = () => castVote(p.id, btn);
            container.appendChild(btn);
        });
        
        updateUIForHost(); // Mostrar bot√≥n de forzar si soy host
    }

    function castVote(targetId, btnElement) {
        if (hasVoted) return;
        hasVoted = true;
        
        // Efecto visual
        const allBtns = document.querySelectorAll('.vote-btn');
        allBtns.forEach(b => b.style.opacity = '0.5');
        btnElement.style.opacity = '1';
        btnElement.classList.add('selected');
        
        document.getElementById('vote-status').innerText = "Voto enviado. Esperando a los dem√°s...";

        // Enviar a Firebase (votes/myId = targetId)
        db.ref('rooms/' + roomId + '/gameState/votes/' + myId).set(targetId);
    }

    // --- L√ìGICA COMPARTIDA ---
    function calculateGameSetup(playersArray, imposterSetting, categoryKey, difficulty) {
        let keys = Object.keys(database);
        if (categoryKey !== 'random') keys = [categoryKey];
        const chosenCat = keys[Math.floor(Math.random() * keys.length)];
        const items = database[chosenCat];
        const secretItem = items[Math.floor(Math.random() * items.length)];

        // CALCULAR N√öMERO DE IMPOSTORES
        let imposterCount = 1;
        if (imposterSetting === 'random') {
            // Si hay pocos jugadores (menos de 5), forzar 1 impostor
            if (playersArray.length < 5) imposterCount = 1;
            else imposterCount = Math.random() < 0.5 ? 1 : 2;
        } else {
            imposterCount = parseInt(imposterSetting);
        }

        // Shuffle
        let indices = playersArray.map((_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        
        const impostorIndices = indices.slice(0, imposterCount);
        const starterIndex = Math.floor(Math.random() * playersArray.length);
        const starterName = playersArray[starterIndex].name;

        let rolesMap = {};
        let impostorNames = [];

        playersArray.forEach((p, i) => {
            let isImposter = impostorIndices.includes(i);
            if(isImposter) impostorNames.push(p.name);
            rolesMap[p.id] = {
                isImposter: isImposter,
                word: secretItem.word,
                hint: secretItem.hints[difficulty] || "Sin pista",
                showHint: difficulty !== 'none'
            };
        });

        return {
            categoryName: chosenCat.toUpperCase(),
            roles: rolesMap,
            impostorNames: impostorNames,
            secretWord: secretItem.word,
            starterName: starterName
        };
    }

    function startSharedGameLogic(players, imposterSetting, catKey, diff) {
        const setup = calculateGameSetup(players, imposterSetting, catKey, diff);
        db.ref('rooms/' + roomId + '/gameState').set({
            phase: 'assigned',
            categoryName: setup.categoryName,
            roles: setup.roles,
            impostorNames: setup.impostorNames,
            secretWord: setup.secretWord,
            starterName: setup.starterName,
            votes: {} // Reset votos
        });
    }

    function confirmRoleSeen() {
        if (CURRENT_MODE === 'online') {
            switchScreen('game-screen');
            document.getElementById('timer').innerText = "ESPERANDO...";
            document.getElementById('starter-name').innerText = "...";
            document.getElementById('btn-review-role').style.display = 'block';
            document.getElementById('host-game-controls').style.display = 'none';
            if(isHost) {
                 const now = Date.now();
                 const duration = 180 * 1000; 
                 db.ref('rooms/' + roomId + '/gameState').update({
                    phase: 'playing', startTime: now, endTime: now + duration
                });
            }
        } else {
            nextOfflinePlayer();
        }
    }

    function goToGame() { confirmRoleSeen(); }

    function revealMyRole(data) {
        switchScreen('role-screen');
        const card = document.getElementById('role-card-display');
        const text = document.getElementById('role-text');
        const hint = document.getElementById('role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        if (data.isImposter) {
            card.classList.add('imposter-reveal'); text.innerText = "üïµÔ∏è IMPOSTOR";
            if (data.showHint) { hint.style.display = 'block'; hint.innerText = "Pista: " + data.hint; }
        } else { text.innerText = data.word; }
        document.getElementById('category-display').innerText = "Categor√≠a: " + data.categoryName;
    }

    function startLocalTimer(endTime, starterName) {
        switchScreen('game-screen');
        document.getElementById('starter-name').innerText = starterName;
        
        if (CURRENT_MODE === 'online') {
            updateUIForHost();
            document.getElementById('offline-game-controls').style.display = 'none';
            document.getElementById('btn-review-role').style.display = 'block';
        } else {
            document.getElementById('host-game-controls').style.display = 'none';
            document.getElementById('offline-game-controls').style.display = 'block';
            document.getElementById('btn-review-role').style.display = 'none';
        }

        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const now = Date.now();
            const left = Math.max(0, Math.floor((endTime - now) / 1000));
            const m = Math.floor(left / 60).toString().padStart(2,'0');
            const s = (left % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            if (left <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "00:00";
                if (CURRENT_MODE === 'online' && isHost) startVotingGlobal();
            }
        }, 1000);
    }

    function endGameGlobal() {
        if (CURRENT_MODE === 'online') {
            db.ref('rooms/' + roomId + '/gameState').update({ phase: 'finished' });
        } else {
            showResults(currentGameState);
        }
    }

    function showResults(state) {
        clearInterval(timerInterval);
        switchScreen('result-screen');
        document.getElementById('result-impostors').innerText = state.impostorNames.join(" y ");
        document.getElementById('result-word').innerText = state.secretWord;

        // Mostrar Resultados de Votaci√≥n (Solo online)
        const voteBox = document.getElementById('voting-results-display');
        const votesList = document.getElementById('votes-list');
        
        if (CURRENT_MODE === 'online' && state.votes) {
            voteBox.style.display = 'block';
            votesList.innerHTML = "";
            
            // Contar votos
            let voteCounts = {};
            Object.values(state.votes).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });

            // Mostrar lista
            for (let [targetId, count] of Object.entries(voteCounts)) {
                // Buscar nombre del jugador
                const p = playersInRoom.find(pl => pl.id === targetId);
                const name = p ? p.name : "Desconocido";
                const isImp = state.roles[targetId] && state.roles[targetId].isImposter;
                
                const li = document.createElement('li');
                li.innerHTML = `<b>${name}</b>: ${count} votos ${isImp ? 'üòà' : 'üòá'}`;
                votesList.appendChild(li);
            }
        } else {
            voteBox.style.display = 'none';
        }

        if (CURRENT_MODE === 'online') {
            updateUIForHost();
            document.getElementById('offline-restart-btn').style.display = 'none';
        } else {
            document.getElementById('host-score-controls').style.display = 'none';
            document.getElementById('host-restart-controls').style.display = 'none';
            document.getElementById('client-wait-restart').style.display = 'none';
            document.getElementById('offline-restart-btn').style.display = 'block';
        }
    }

    // --- OFFLINE FUNCTIONS ---
    function handleEnterOffline(e) { if(e.key === 'Enter') addOfflinePlayer(); }
    
    function addOfflinePlayer() {
        const input = document.getElementById('offline-new-player');
        const name = input.value.trim();
        if (name) {
            offlinePlayers.push({ name: name, id: 'off-' + Date.now() + Math.random() });
            input.value = "";
            renderOfflineList();
        }
    }

    function removeOfflinePlayer(index) {
        offlinePlayers.splice(index, 1);
        renderOfflineList();
    }

    function renderOfflineList() {
        const list = document.getElementById('offline-player-list');
        list.innerHTML = "";
        offlinePlayers.forEach((p, i) => {
            const li = document.createElement('li');
            li.className = 'player-item';
            li.innerHTML = `<span>üë§ ${p.name}</span><button class="delete-btn" onclick="removeOfflinePlayer(${i})">‚úï</button>`;
            list.appendChild(li);
        });
    }

    function startOfflineGame() {
        if (offlinePlayers.length < 3) return alert("M√≠nimo 3 jugadores.");
        const imposterSetting = document.getElementById('offline-imposter-count').value;
        // Validaci√≥n offline simple para impostores fijos
        if (imposterSetting !== 'random' && offlinePlayers.length <= parseInt(imposterSetting)) return alert("Demasiados impostores.");
        
        const categoryKey = document.getElementById('offline-category-select').value;
        const difficulty = document.getElementById('offline-difficulty-select').value;

        const setup = calculateGameSetup(offlinePlayers, imposterSetting, categoryKey, difficulty);
        currentGameState = setup;
        currentOfflineIndex = 0;
        showOfflinePassScreen();
    }

    function showOfflinePassScreen() {
        switchScreen('offline-pass-screen');
        const p = offlinePlayers[currentOfflineIndex];
        document.getElementById('offline-current-player-display').innerText = p.name;
        document.getElementById('offline-current-player-text').innerText = p.name;
    }

    function showOfflineRole() {
        const p = offlinePlayers[currentOfflineIndex];
        const roleData = currentGameState.roles[p.id];
        mySavedRoleData = { ...roleData, categoryName: currentGameState.categoryName }; 
        revealMyRole(mySavedRoleData);
    }

    function nextOfflinePlayer() {
        currentOfflineIndex++;
        if (currentOfflineIndex < offlinePlayers.length) {
            showOfflinePassScreen();
        } else {
            startLocalTimer(Date.now() + 180 * 1000, currentGameState.starterName);
        }
    }

    function resetOfflineGame() { switchScreen('offline-setup-screen'); }

    // Helpers
    function openRoleReview() {
        if (!mySavedRoleData) return;
        const card = document.getElementById('review-card-display');
        const text = document.getElementById('review-role-text');
        const hint = document.getElementById('review-role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        if (mySavedRoleData.isImposter) {
            card.classList.add('imposter-reveal'); text.innerText = "üïµÔ∏è IMPOSTOR";
            if (mySavedRoleData.showHint) { hint.style.display = 'block'; hint.innerText = "Pista: " + mySavedRoleData.hint; }
        } else { text.innerText = mySavedRoleData.word; }
        document.getElementById('review-category-display').innerText = "Categor√≠a: " + mySavedRoleData.categoryName;
        document.getElementById('review-overlay').style.display = 'flex';
    }
    function closeRoleReview() { document.getElementById('review-overlay').style.display = 'none'; }
    function exitGame() { if(confirm("¬øSalir?")) { if(roomId && myId && CURRENT_MODE === 'online') db.ref('rooms/' + roomId + '/players/' + myId).remove(); window.location.reload(); } }
    function distributePoints(winnerType) {
        if (!isHost || !currentGameState || !currentGameState.roles) return;
        const updates = {};
        playersInRoom.forEach(p => {
            const role = currentGameState.roles[p.id];
            let currentScore = p.score || 0;
            let pointsToAdd = 0;
            if (winnerType === 'civilians' && role && !role.isImposter) pointsToAdd = 1;
            if (winnerType === 'impostors' && role && role.isImposter) pointsToAdd = 3;
            if (pointsToAdd > 0) { updates['players/' + p.id + '/score'] = currentScore + pointsToAdd; }
        });
        db.ref('rooms/' + roomId).update(updates).then(() => { returnToLobbyGlobal(); });
    }
    function returnToLobbyGlobal() { if (CURRENT_MODE === 'online') { db.ref('rooms/' + roomId + '/gameState').set({ phase: 'reset' }); } }
    function resetLocalGame() { enterLobbyUI(); mySavedRoleData = null; }
</script>
</body>
</html>