<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Impostor - Base de Datos Ampliada</title>
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta property="og:title" content="üïµÔ∏è Juego del Impostor">
    <meta property="og:description" content="¬øPodr√°s descubrir qui√©n miente? Juega online o en persona con tus amigos.">
    <meta property="og:image" content="logo.png">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#e94560">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --glass-bg: rgba(22, 33, 62, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #e94560;
            --text-main: #ffffff;
            --text-secondary: #bdc3c7;
            --btn-color: #0f3460;
            --danger-color: #ff4757;
            --success-color: #2ecc71;
            --whatsapp-color: #25D366;
            --input-bg: rgba(0, 0, 0, 0.5); 
            --option-bg: #000000;
            --option-text: #ffffff;
            --bg-gradient: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #1a1a2e);
        }

        body.light-mode {
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --accent-color: #ff6b6b;
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --btn-color: #54a0ff;
            --danger-color: #ff4757;
            --success-color: #1dd1a1;
            --input-bg: rgba(0, 0, 0, 0.05); 
            --option-bg: #ffffff;
            --option-text: #000000;
            --bg-gradient: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            overscroll-behavior-y: none;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: color 0.3s ease;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container {
            background-color: var(--glass-bg);
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            width: 90%;
            max-width: 420px;
            max-height: 95vh;
            margin: 0 auto;
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .container::-webkit-scrollbar { display: none; }

        #connection-status {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: var(--danger-color); color: white; 
            font-size: 0.8rem; padding: 5px; z-index: 9999; 
            display: none; font-weight: bold; text-align: center;
        }
        
        .theme-switch-wrapper { position: absolute; top: 10px; left: 30px; display: flex; align-items: center; z-index: 10; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: rgba(0,0,0,0.3); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; font-size: 14px; }
        .slider .icon { z-index: 1; pointer-events: none; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 20px; left: 4px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; z-index: 2; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        h1 { margin-bottom: 1rem; color: var(--accent-color); text-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 2.2rem; font-weight: 800; letter-spacing: -0.5px; margin-top: 10px; }
        .screen { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"], select {
            padding: 14px; border-radius: 14px; border: 1px solid var(--glass-border); 
            width: 100%; box-sizing: border-box; font-size: 16px; background: var(--input-bg); 
            color: var(--text-main); outline: none; transition: all 0.2s; appearance: none; -webkit-appearance: none;
        }
        input[type="text"]:focus, select:focus { background: rgba(125, 125, 125, 0.1); border-color: var(--accent-color); }
        select:disabled { opacity: 0.6; }
        select option { background-color: var(--option-bg); color: var(--option-text); }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23888888%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4-3.7%203.7-5.4%208-5.4%2013%200%205%201.8%209.3%205.4%2013l128%20128c3.7%203.7%208%205.4%2013%205.4s9.3-1.8%2013-5.4l128-128c3.7-3.7%205.4-8%205.4-13%200-5-1.8-9.3-5.4-13z%27%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 1em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        label { display: block; text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        button {
            background-color: var(--accent-color); color: white; border: none; padding: 16px 30px; 
            border-radius: 16px; font-size: 1.1rem; cursor: pointer; width: 100%; font-weight: 700;
            transition: transform 0.1s, opacity 0.2s; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.7; cursor: wait; }
        
        button.small-btn { width: auto; padding: 0 20px; margin: 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; }
        button.secondary { background-color: var(--btn-color); box-shadow: none; }
        button.danger { background-color: var(--danger-color); margin-top: 25px; }
        button.exit-btn { width: auto; padding: 5px 12px; font-size: 0.8rem; background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); margin: 0; box-shadow: none; }
        button.whatsapp-btn { background-color: var(--whatsapp-color); font-size: 0.9rem; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .vote-btn { background-color: var(--input-bg); border: 1px solid var(--glass-border); text-align: left; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; }
        .vote-btn.selected { background-color: var(--accent-color); border-color: var(--accent-color); }

        .mode-btn { padding: 25px; font-size: 1.3rem; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .mode-subtext { font-size: 0.8rem; font-weight: normal; opacity: 0.8; }

        #player-list-lobby, #offline-player-list { list-style: none; padding: 0; margin: 10px 0; max-height: 20vh; overflow-y: auto; scrollbar-width: thin; }
        .lobby-player, .player-item { background: var(--input-bg); padding: 10px; margin: 5px 0; border-radius: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border); transition: all 0.3s; }
        .delete-btn { background: #ff7675; border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; box-shadow: none; }

        .me-badge { font-size: 0.7rem; background: var(--success-color); padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-left: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .host-badge { font-size: 0.7rem; background: #f1c40f; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-right: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .score-badge { font-size: 0.9rem; font-weight: bold; color: var(--accent-color); background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; min-width: 30px; text-align: center; }

        .role-card { 
            background: var(--input-bg); color: var(--text-main); padding: 30px 20px; border-radius: 20px; margin: 20px 0; 
            font-size: 2rem; font-weight: 800; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 150px; height: auto; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: visible;
        }
        .imposter-reveal { background: rgba(255, 71, 87, 0.2); border: 1px solid var(--danger-color); color: var(--danger-color); }
        .hint-box { display: block; margin-top: 15px; font-size: 1rem; font-weight: 500; background: rgba(0,0,0,0.1); color: var(--text-main); padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; }
        
        #timer { font-size: 4rem; margin: 10px 0; font-weight: 800; color: var(--accent-color); font-family: 'Courier New', monospace; text-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .room-code-display { font-size: 2.5rem; font-weight: bold; letter-spacing: 5px; color: var(--success-color); margin: 5px 0; background: var(--input-bg); padding: 5px; border-radius: 10px; }

        #review-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--glass-bg); z-index: 2000; 
            padding: 20px; box-sizing: border-box; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            border-radius: 24px; backdrop-filter: blur(20px); overflow-y: auto;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #review-overlay::-webkit-scrollbar { display: none; }

        .close-icon-overlay { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; color: var(--text-main); cursor: pointer; z-index: 2001; font-weight: bold; line-height: 1; }
        
        .lobby-settings-box { border-top: 1px solid var(--glass-border); padding-top: 15px; margin-top: 10px; text-align: left; }
        .host-badge-settings { font-size: 0.7rem; color: var(--success-color); float: right; font-weight: normal; margin-top: 3px; }
        .header-game { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; min-height: 30px;}
        .lobby-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; }
        .score-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .score-btn-civ { background-color: var(--btn-color); font-size: 0.9rem; }
        .score-btn-imp { background-color: var(--danger-color); font-size: 0.9rem; margin-top: 0;}
        .seo-content { margin-top: 30px; text-align: left; font-size: 0.85rem; opacity: 0.8; border-top: 1px solid var(--glass-border); padding-top: 15px; line-height: 1.4; }
        .seo-content h2 { font-size: 1rem; color: var(--accent-color); margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="connection-status">‚ö†Ô∏è Sin conexi√≥n a internet</div>

<div class="container">
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox-theme">
            <input type="checkbox" id="checkbox-theme" onchange="toggleTheme()">
            <div class="slider round">
                <span class="icon" style="margin-left: 4px;">üåô</span>
                <span class="icon" style="margin-right: 4px;">‚òÄÔ∏è</span>
            </div>
        </label>
    </div>

    <div id="mode-selection-screen" class="screen active">
        <h1>üïµÔ∏è El Impostor</h1>
        <p style="opacity: 0.8; margin-bottom: 20px;">Elige c√≥mo quieres jugar:</p>
        <button class="mode-btn" onclick="selectMode('offline')">
            üè† Jugar en Persona
            <span class="mode-subtext">1 solo m√≥vil (Pasar y jugar)</span>
        </button>
        <button class="mode-btn secondary" onclick="selectMode('online')">
            üåê Jugar Online
            <span class="mode-subtext">Cada uno en su casa</span>
        </button>
        <div class="seo-content">
            <h2>¬øC√≥mo jugar al Impostor?</h2>
            <p>El Impostor es un juego de deducci√≥n social. Todos reciben una palabra secreta menos los impostores.</p>
            <p>Descubre qui√©n miente haciendo preguntas, o intenta pasar desapercibido si eres el impostor.</p>
        </div>
    </div>

    <div id="online-home-screen" class="screen">
        <div class="header-game"><button onclick="goBackToMode()" class="exit-btn">‚Üê Volver</button></div>
        <h1>Modo Online</h1>
        <input type="text" id="player-name-input" placeholder="Tu Nombre" maxlength="12">
        <div style="margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <button onclick="createRoom()" id="btn-create">üëë Crear Nueva Sala</button>
            <p style="margin: 15px 0; opacity: 0.7;">- O -</p>
            <input type="text" id="room-code-input" placeholder="C√≥digo de Sala" style="text-transform: uppercase;">
            <button class="secondary" onclick="joinRoom()" id="btn-join">Entrar en Sala</button>
        </div>
    </div>

    <div id="offline-setup-screen" class="screen">
        <div class="header-game"><button onclick="goBackToMode()" class="exit-btn">‚Üê Volver</button></div>
        <h1>Modo Offline</h1>
        <label style="margin-top:0;">A√±adir Jugadores (min 3):</label>
        <div class="input-group">
            <input type="text" id="offline-new-player" placeholder="Ej: Ana" onkeypress="handleEnterOffline(event)" autocomplete="off">
            <button class="small-btn" onclick="addOfflinePlayer()">+</button>
        </div>
        <ul id="offline-player-list"></ul>
        <div class="lobby-settings-box">
            <label>CONFIGURACI√ìN</label>
            <select id="offline-imposter-count">
                <option value="random" selected>üé≤ Aleatorio (1, 2 o 3)</option>
                <option value="1">1 Impostor</option>
                <option value="2">2 Impostores</option>
                <option value="3">3 Impostores</option>
            </select>
            <select id="offline-category-select">
                <option value="random">üé≤ Categor√≠a Aleatoria</option>
                <option value="lugares">üåç Lugares</option>
                <option value="comida">üçï Comida</option>
                <option value="animales">üê∂ Animales</option>
                <option value="profesiones">üíº Profesiones</option>
                <option value="deportes">‚öΩ Deportes</option>
                <option value="instrumentos">üé∏ Instrumentos</option>
                <option value="ropa">üëï Ropa</option>
            </select>
            <select id="offline-difficulty-select">
                <option value="easy">üü¢ Pista F√°cil</option>
                <option value="medium">üü° Pista Media</option>
                <option value="hard">üî¥ Pista Dif√≠cil</option>
                <option value="very_hard">üíÄ Pista Muy Dif√≠cil</option>
            </select>
            <select id="offline-imposter-sees-category">
                <option value="no">üôà Impostor NO ve Categor√≠a</option>
                <option value="yes">üëÅÔ∏è Impostor S√ç ve Categor√≠a</option>
            </select>
            <button onclick="startOfflineGame()" class="btn-start-margin">Empezar Partida</button>
        </div>
    </div>

    <div id="offline-pass-screen" class="screen">
        <h2>Turno de:</h2>
        <span id="offline-current-player-display" style="font-size: 2rem; font-weight: bold; color: var(--accent-color); display: block; margin: 10px 0;">Jugador</span>
        <p style="opacity: 0.8; margin-bottom: 20px;">Pasa el dispositivo a <span id="offline-current-player-text"></span>.<br>Nadie m√°s debe mirar.</p>
        <div style="font-size: 5rem; margin: 30px 0; opacity: 0.8; animation: pulse 2s infinite;">üì±üñêÔ∏è</div>
        <button onclick="showOfflineRole()">Ver mi Rol</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-header">
            <button onclick="exitGame()" class="exit-btn">‚úï Salir</button>
        </div>
        <h2 style="font-size: 0.9rem; opacity: 0.7; margin-bottom:5px;">C√ìDIGO DE SALA:</h2>
        <div id="display-room-code" class="room-code-display">----</div>
        <button onclick="shareWhatsApp()" class="whatsapp-btn">üì± Compartir por WhatsApp</button>
        <p style="margin-bottom: 5px; opacity: 0.7; font-size: 0.9rem; margin-top: 20px;">Jugadores:</p>
        <ul id="player-list-lobby"></ul>
        <div class="lobby-settings-box">
            <label>CONFIGURACI√ìN <span id="settings-status-text" class="host-badge-settings"></span></label>
            <select id="imposter-count" onchange="syncSettings()">
                <option value="random" selected>üé≤ Aleatorio (1, 2 o 3)</option>
                <option value="1">1 Impostor</option>
                <option value="2">2 Impostores</option>
                <option value="3">3 Impostores</option>
            </select>
            <select id="category-select" onchange="syncSettings()">
                <option value="random">üé≤ Categor√≠a Aleatoria</option>
                <option value="lugares">üåç Lugares</option>
                <option value="comida">üçï Comida</option>
                <option value="animales">üê∂ Animales</option>
                <option value="profesiones">üíº Profesiones</option>
                <option value="deportes">‚öΩ Deportes</option>
                <option value="instrumentos">üé∏ Instrumentos</option>
                <option value="ropa">üëï Ropa</option>
            </select>
            <select id="difficulty-select" onchange="syncSettings()">
                <option value="easy">üü¢ Pista F√°cil</option>
                <option value="medium">üü° Pista Media</option>
                <option value="hard">üî¥ Pista Dif√≠cil</option>
                <option value="very_hard">üíÄ Pista Muy Dif√≠cil</option>
            </select>
            <select id="imposter-sees-category" onchange="syncSettings()">
                <option value="no">üôà Impostor NO ve Categor√≠a</option>
                <option value="yes">üëÅÔ∏è Impostor S√ç ve Categor√≠a</option>
            </select>
            <button id="btn-start-game" onclick="startGame()" style="display:none;">üöÄ EMPEZAR PARTIDA</button>
            <p id="waiting-msg" style="display:none; color: var(--success-color); animation: pulse 1.5s infinite; text-align: center; margin-top: 15px;">Esperando al anfitri√≥n...</p>
        </div>
    </div>

    <div id="role-screen" class="screen">
        <h2>Tu Rol</h2>
        <div id="role-card-display" class="role-card">
            <span id="role-text">...</span>
            <div id="role-hint" class="hint-box" style="display:none"></div>
        </div>
        <p id="category-display" style="opacity: 0.7;"></p>
        <button onclick="confirmRoleSeen()">Entendido, Ocultar</button>
    </div>

    <div id="game-screen" class="screen" style="position: relative;">
        <div class="header-game"><button onclick="exitGame()" class="exit-btn">‚úï Salir</button></div>
        <div id="review-overlay">
            <div class="close-icon-overlay" onclick="closeRoleReview()">‚úï</div>
            <h2 style="margin-bottom: 20px;">Tu Rol Secreto</h2>
            <div id="review-card-display" class="role-card" style="width: 100%;">
                <span id="review-role-text">...</span>
                <div id="review-role-hint" class="hint-box" style="display:none"></div>
            </div>
            <p id="review-category-display" style="opacity: 0.7;"></p>
            <button onclick="closeRoleReview()" class="secondary">Cerrar</button>
        </div>
        <div style="background: var(--input-bg); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--glass-border);">
            <p style="margin:0; font-size:0.8rem; opacity:0.7;">EMPIEZA HABLANDO:</p>
            <h2 id="starter-name" style="margin:5px 0;">?</h2>
        </div>
        <div id="timer">03:00</div>
        <button id="btn-review-role" onclick="openRoleReview()" class="secondary" style="font-size: 0.9rem; padding: 10px; margin-bottom: 20px;">üëÅÔ∏è Recordar mi palabra</button>
        <div id="host-game-controls" style="display:none;">
            <button class="danger" onclick="startVotingGlobal()">üö® RESOLVER / VOTAR</button>
        </div>
        <div id="offline-game-controls" style="display:none;">
            <button class="danger" onclick="endGameGlobal()">üö® RESOLVER</button>
        </div>
    </div>

    <div id="voting-screen" class="screen">
        <h2>üó≥Ô∏è Votaci√≥n</h2>
        <p style="opacity: 0.8; margin-bottom:15px;">Elige a qui√©n acusar:</p>
        <div id="voting-buttons-container"></div>
        <p id="vote-status" style="margin-top:20px; font-style:italic; opacity:0.7;"></p>
        
        <div id="host-voting-controls" style="display:none; margin-top:20px;">
            <button onclick="endGameGlobal()" class="small-btn" style="font-size:1rem; width:100%;">Forzar Resultados</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="header-game"><button onclick="exitGame()" class="exit-btn">‚úï Salir</button></div>
        <h1>FIN DE PARTIDA</h1>
        
        <div id="voting-results-display" style="display:none; margin-bottom:20px; background: rgba(0,0,0,0.2); padding:10px; border-radius:10px;">
            <h3 style="font-size:1rem; margin-top:0;">Resultados Votaci√≥n:</h3>
            <ul id="votes-list" style="list-style:none; padding:0; text-align:left; font-size:0.9rem;"></ul>
        </div>

        <div style="background: var(--input-bg); padding: 20px; border-radius: 15px; border: 2px solid var(--accent-color);">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">IMPOSTOR(ES):</p>
            <div id="result-impostors" style="font-size: 1.8rem; font-weight: bold; color: var(--accent-color); margin: 10px 0;">-</div>
            <hr style="border-color: var(--glass-border)">
            <p style="margin:0; opacity: 0.7; font-size: 0.9rem;">PALABRA SECRETA:</p>
            <div id="result-word" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-top: 5px;">-</div>
        </div>
        
        <div id="host-score-controls" style="display:none; margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 15px;">
            <p style="font-size: 0.9rem; margin-bottom: 10px;">¬øQUI√âN GAN√ì?</p>
            <div class="score-btn-group">
                <button class="score-btn-civ" onclick="distributePoints('civilians')">üòá Ciudadanos (+1)</button>
                <button class="score-btn-imp" onclick="distributePoints('impostors')">üòà Impostor (+3)</button>
            </div>
            <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 10px;">(Puntuar reinicia la partida)</p>
        </div>

        <div id="offline-score-controls" style="display:none; margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 15px;">
            <p style="font-size: 0.9rem; margin-bottom: 10px;">¬øQUI√âN GAN√ì?</p>
            <div class="score-btn-group">
                <button class="score-btn-civ" onclick="distributeOfflinePoints('civilians')">üòá Ciudadanos (+1)</button>
                <button class="score-btn-imp" onclick="distributeOfflinePoints('impostors')">üòà Impostor (+3)</button>
            </div>
        </div>

        <div id="host-restart-controls" style="display:none;">
            <button onclick="returnToLobbyGlobal()" style="background:transparent; border:1px solid var(--glass-border); font-size:0.8rem; margin-top:10px;">Reiniciar sin puntuar</button>
        </div>
        
        <div id="client-wait-restart" style="display:none; margin-top:20px;">
            <p id="waiting-restart" style="animation: pulse 1.5s infinite;">Esperando al anfitri√≥n...</p>
        </div>
        
        <button id="offline-restart-btn" onclick="resetOfflineGame()" style="display:none; margin-top:20px; background:transparent; border:1px solid var(--glass-border); font-size:0.8rem;">Reiniciar sin puntuar</button>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // FIREBASE
    // ---------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCD9EZAZldGoBHv5-v9jQ8wfOSVPL9mu60",
        authDomain: "juego-del-impostor-9318e.firebaseapp.com",
        databaseURL: "https://juego-del-impostor-9318e-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juego-del-impostor-9318e",
        storageBucket: "juego-del-impostor-9318e.firebasestorage.app",
        messagingSenderId: "952474577416",
        appId: "1:952474577416:web:3b13fa3169b12114787fbd",
        measurementId: "G-704F1P5P2J"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", (snap) => {
        const banner = document.getElementById('connection-status');
        if (snap.val() === true) banner.style.display = 'none'; else banner.style.display = 'block';
    });

    async function requestWakeLock() { if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); } } }

    // --- VARIABLES ---
    let CURRENT_MODE = ''; 
    let myName = "";
    let myId = localStorage.getItem('impostor_myId') || ""; 
    let roomId = "";
    let isHost = false;
    let playersInRoom = [];
    let offlinePlayers = [];
    let offlineUsedWords = []; 
    let currentOfflineIndex = 0;
    let timerInterval;
    let mySavedRoleData = null; 
    let currentGameState = null;
    let hasVoted = false;

    // --- BASE DE DATOS MASIVA ---
    const database = {
        lugares: [
            { word: "Playa", hints: { easy: "Arena", medium: "Sal", hard: "Marea", very_hard: "Litoral" } },
            { word: "Hospital", hints: { easy: "Silencio", medium: "Bata", hard: "Guardia", very_hard: "Asepsia" } },
            { word: "Escuela", hints: { easy: "Pizarra", medium: "Recreo", hard: "Septiembre", very_hard: "Pedagog√≠a" } },
            { word: "Cine", hints: { easy: "Palomitas", medium: "Butaca", hard: "Estreno", very_hard: "Proyector" } },
            { word: "Supermercado", hints: { easy: "Carrito", medium: "Pasillo", hard: "Bolsa", very_hard: "G√≥ndola" } },
            { word: "Avi√≥n", hints: { easy: "Nubes", medium: "Maleta", hard: "Pasaporte", very_hard: "Presurizaci√≥n" } },
            { word: "Zool√≥gico", hints: { easy: "Jaula", medium: "Safari", hard: "Domingo", very_hard: "Cautiverio" } },
            { word: "Biblioteca", hints: { easy: "Silencio", medium: "Pr√©stamo", hard: "Estanter√≠a", very_hard: "Catalogaci√≥n" } },
            { word: "Restaurante", hints: { easy: "Men√∫", medium: "Propina", hard: "Reserva", very_hard: "Mise en place" } },
            { word: "Gimnasio", hints: { easy: "Pesas", medium: "Sudor", hard: "Mancuerna", very_hard: "Hipertrofia" } },
            { word: "Iglesia", hints: { easy: "Rezar", medium: "Domingo", hard: "Altar", very_hard: "Eucarist√≠a" } },
            { word: "Parque", hints: { easy: "Columpio", medium: "Banco", hard: "Paseo", very_hard: "Esparcimiento" } },
            { word: "Banco", hints: { easy: "Dinero", medium: "Cajero", hard: "Hipoteca", very_hard: "Inter√©s" } },
            { word: "Hotel", hints: { easy: "Cama", medium: "Recepci√≥n", hard: "Estrellas", very_hard: "Check-in" } },
            { word: "C√°rcel", hints: { easy: "Rejas", medium: "Naranja", hard: "Celda", very_hard: "Penitenciar√≠a" } },
            { word: "Cementerio", hints: { easy: "Tumba", medium: "Flores", hard: "L√°pida", very_hard: "Camposanto" } },
            { word: "Museo", hints: { easy: "Arte", medium: "Cuadro", hard: "Gu√≠a", very_hard: "Curador" } },
            { word: "Farmacia", hints: { easy: "Cruz", medium: "Receta", hard: "Jarabe", very_hard: "Boticario" } },
            { word: "Estadio", hints: { easy: "Grada", medium: "C√©sped", hard: "Afici√≥n", very_hard: "Aforo" } },
            { word: "Circo", hints: { easy: "Carpa", medium: "Payaso", hard: "Trapecio", very_hard: "Itinerante" } },
            { word: "Discoteca", hints: { easy: "M√∫sica", medium: "Luces", hard: "Copas", very_hard: "Pista" } },
            { word: "Monta√±a", hints: { easy: "Nieve", medium: "Altura", hard: "Cima", very_hard: "Alpinismo" } },
            { word: "Desierto", hints: { easy: "Calor", medium: "Arena", hard: "Cactus", very_hard: "Oasis" } },
            { word: "Bosque", hints: { easy: "√Årboles", medium: "Verde", hard: "Sombra", very_hard: "Espesura" } },
            { word: "Espacio", hints: { easy: "Estrellas", medium: "Vac√≠o", hard: "Gravedad", very_hard: "Cosmos" } },
            { word: "Submarino", hints: { easy: "Agua", medium: "Profundo", hard: "Periscopio", very_hard: "Inmersi√≥n" } }
        ],
        comida: [
            { word: "Pizza", hints: { easy: "Italia", medium: "Caja", hard: "Tri√°ngulo", very_hard: "Fermentaci√≥n" } },
            { word: "Sushi", hints: { easy: "Jap√≥n", medium: "Palillos", hard: "Crudo", very_hard: "Vinagre" } },
            { word: "Hamburguesa", hints: { easy: "Pan", medium: "Ketchup", hard: "R√°pida", very_hard: "S√©samo" } },
            { word: "Helado", hints: { easy: "Verano", medium: "Derrite", hard: "Cuchara", very_hard: "Cremosidad" } },
            { word: "Chocolate", hints: { easy: "Suiza", medium: "Tableta", hard: "Amargo", very_hard: "Temperado" } },
            { word: "Ensalada", hints: { easy: "Dieta", medium: "Aceite", hard: "Mezclar", very_hard: "Ali√±o" } },
            { word: "Tacos", hints: { easy: "M√©xico", medium: "Tortilla", hard: "Picante", very_hard: "Pastor" } },
            { word: "Paella", hints: { easy: "Arroz", medium: "Domingo", hard: "Azafr√°n", very_hard: "Socarrat" } },
            { word: "Espaguetis", hints: { easy: "Largo", medium: "Tomate", hard: "Tenedor", very_hard: "Al dente" } },
            { word: "Sopa", hints: { easy: "Cuchara", medium: "Caliente", hard: "Fideos", very_hard: "Caldo" } },
            { word: "Pollo frito", hints: { easy: "Crujiente", medium: "Grasa", hard: "Cubo", very_hard: "Rebozado" } },
            { word: "Huevo frito", hints: { easy: "Desayuno", medium: "Yema", hard: "Sart√©n", very_hard: "Clara" } },
            { word: "Pan", hints: { easy: "Miga", medium: "Horno", hard: "Corteza", very_hard: "Levadura" } },
            { word: "Queso", hints: { easy: "Rat√≥n", medium: "Leche", hard: "Agujeros", very_hard: "Curaci√≥n" } },
            { word: "Manzana", hints: { easy: "Roja", medium: "Fruta", hard: "Blancanieves", very_hard: "Sidra" } },
            { word: "Pl√°tano", hints: { easy: "Amarillo", medium: "Mono", hard: "Potasio", very_hard: "Canarias" } },
            { word: "Sand√≠a", hints: { easy: "Verde", medium: "Roja", hard: "Pepitas", very_hard: "Hidrataci√≥n" } },
            { word: "Pastel", hints: { easy: "Cumplea√±os", medium: "Velas", hard: "Dulce", very_hard: "Reposteria" } },
            { word: "Donut", hints: { easy: "Agujero", medium: "Polic√≠a", hard: "Glaseado", very_hard: "Rosquilla" } },
            { word: "Caf√©", hints: { easy: "Ma√±ana", medium: "Negro", hard: "Cafe√≠na", very_hard: "Tueste" } },
            { word: "Cerveza", hints: { easy: "Espuma", medium: "Rubia", hard: "Cebada", very_hard: "L√∫pulo" } },
            { word: "Vino", hints: { easy: "Copa", medium: "Uva", hard: "Tinto", very_hard: "Taninos" } },
            { word: "Agua", hints: { easy: "Sed", medium: "Transparente", hard: "Grifo", very_hard: "H2O" } },
            { word: "Kebab", hints: { easy: "Rollo", medium: "Carne", hard: "Salsa", very_hard: "Giratorio" } },
            { word: "Perrito caliente", hints: { easy: "Salchicha", medium: "Pan", hard: "Mostaza", very_hard: "Frankfurt" } }
        ],
        animales: [
            { word: "Perro", hints: { easy: "Amigo", medium: "Hueso", hard: "Correa", very_hard: "Olfato" } },
            { word: "Gato", hints: { easy: "Bigotes", medium: "Siete vidas", hard: "Arena", very_hard: "Retr√°ctil" } },
            { word: "Le√≥n", hints: { easy: "Selva", medium: "Melena", hard: "Rugido", very_hard: "Depredador" } },
            { word: "Elefante", hints: { easy: "Circo", medium: "Man√≠", hard: "Pesado", very_hard: "Paquidermo" } },
            { word: "Tibur√≥n", hints: { easy: "Sangre", medium: "Terror", hard: "Surfista", very_hard: "Cart√≠lago" } },
            { word: "Ping√ºino", hints: { easy: "Traje", medium: "Huevo", hard: "Baile", very_hard: "Ant√°rtida" } },
            { word: "Jirafa", hints: { easy: "Cuello", medium: "Alta", hard: "Manchas", very_hard: "Sabana" } },
            { word: "Mono", hints: { easy: "Banana", medium: "√Årbol", hard: "Cola", very_hard: "Primate" } },
            { word: "Serpiente", hints: { easy: "Suelo", medium: "Veneno", hard: "Escamas", very_hard: "Reptil" } },
            { word: "√Åguila", hints: { easy: "Volar", medium: "Pico", hard: "Garra", very_hard: "Rapaz" } },
            { word: "Delf√≠n", hints: { easy: "Mar", medium: "Salto", hard: "Inteligente", very_hard: "Ecolocalizaci√≥n" } },
            { word: "Ballena", hints: { easy: "Grande", medium: "Oc√©ano", hard: "Chorro", very_hard: "Cet√°ceo" } },
            { word: "Cocodrilo", hints: { easy: "Dientes", medium: "Pantano", hard: "Verde", very_hard: "Saurio" } },
            { word: "Tortuga", hints: { easy: "Lenta", medium: "Caparaz√≥n", hard: "Lechuga", very_hard: "Longeva" } },
            { word: "Oso", hints: { easy: "Miel", medium: "Hibernar", hard: "Pelo", very_hard: "Plant√≠grado" } },
            { word: "Caballo", hints: { easy: "Montar", medium: "Carrera", hard: "Relincho", very_hard: "Equino" } },
            { word: "Vaca", hints: { easy: "Leche", medium: "Granja", hard: "Pasto", very_hard: "Rumiante" } },
            { word: "Cerdo", hints: { easy: "Rosa", medium: "Jam√≥n", hard: "Barro", very_hard: "Porcino" } },
            { word: "Gallina", hints: { easy: "Huevo", medium: "Plumas", hard: "Corral", very_hard: "Ave" } },
            { word: "Abeja", hints: { easy: "Miel", medium: "Flor", hard: "Amarillo", very_hard: "Polinizaci√≥n" } },
            { word: "Ara√±a", hints: { easy: "Tela", medium: "Ocho", hard: "Miedo", very_hard: "Ar√°cnido" } },
            { word: "Hormiga", hints: { easy: "Peque√±a", medium: "Fila", hard: "Trabajo", very_hard: "Colonia" } },
            { word: "Mariposa", hints: { easy: "Alas", medium: "Colores", hard: "Gusano", very_hard: "Metamorfosis" } },
            { word: "Lobo", hints: { easy: "Luna", medium: "Aullar", hard: "Cuento", very_hard: "Manada" } },
            { word: "Tigre", hints: { easy: "Rayas", medium: "Naranja", hard: "Gato", very_hard: "Felino" } }
        ],
        profesiones: [
            { word: "M√©dico", hints: { easy: "Hospital", medium: "Curar", hard: "Bata", very_hard: "Estetoscopio" } },
            { word: "Bombero", hints: { easy: "Fuego", medium: "Cami√≥n", hard: "Manguera", very_hard: "Sirena" } },
            { word: "Polic√≠a", hints: { easy: "Ladr√≥n", medium: "Pistola", hard: "Esposas", very_hard: "Ley" } },
            { word: "Profesor", hints: { easy: "Escuela", medium: "Ense√±ar", hard: "Pizarra", very_hard: "Examen" } },
            { word: "Cocinero", hints: { easy: "Comida", medium: "Restaurante", hard: "Gorro", very_hard: "Receta" } },
            { word: "Astronauta", hints: { easy: "Espacio", medium: "Cohete", hard: "Casco", very_hard: "Gravedad" } },
            { word: "Pintor", hints: { easy: "Cuadro", medium: "Brocha", hard: "Color", very_hard: "Lienzo" } },
            { word: "Cantante", hints: { easy: "M√∫sica", medium: "Micr√≥fono", hard: "Voz", very_hard: "Concierto" } },
            { word: "Futbolista", hints: { easy: "Bal√≥n", medium: "Gol", hard: "Campo", very_hard: "Liga" } },
            { word: "Juez", hints: { easy: "Mazo", medium: "Juicio", hard: "Justicia", very_hard: "Toga" } },
            { word: "Mec√°nico", hints: { easy: "Coche", medium: "Taller", hard: "Grasa", very_hard: "Motor" } },
            { word: "Peluquero", hints: { easy: "Pelo", medium: "Tijeras", hard: "Peine", very_hard: "Secador" } },
            { word: "Jardinero", hints: { easy: "Plantas", medium: "Flores", hard: "Tierra", very_hard: "Poda" } },
            { word: "Payaso", hints: { easy: "Circo", medium: "Risa", hard: "Nariz", very_hard: "Maquillaje" } },
            { word: "Mago", hints: { easy: "Truco", medium: "Conejo", hard: "Chistera", very_hard: "Ilusi√≥n" } },
            { word: "Presidente", hints: { easy: "Pa√≠s", medium: "Votos", hard: "Gobierno", very_hard: "Mandato" } },
            { word: "Detective", hints: { easy: "Lupa", medium: "Misterio", hard: "Pista", very_hard: "Crimen" } },
            { word: "Carpintero", hints: { easy: "Madera", medium: "Mesa", hard: "Martillo", very_hard: "Serr√≠n" } }
        ],
        deportes: [
            { word: "F√∫tbol", hints: { easy: "Gol", medium: "Once", hard: "Porter√≠a", very_hard: "Estrategia" } },
            { word: "Baloncesto", hints: { easy: "Alto", medium: "Naranja", hard: "NBA", very_hard: "Tablero" } },
            { word: "Tenis", hints: { easy: "Red", medium: "Wimbledon", hard: "Ventaja", very_hard: "Deuce" } },
            { word: "Nataci√≥n", hints: { easy: "Agua", medium: "Piscina", hard: "Ba√±ador", very_hard: "Crol" } },
            { word: "Voleibol", hints: { easy: "Playa", medium: "Red", hard: "Mano", very_hard: "Remate" } },
            { word: "Golf", hints: { easy: "Hoyo", medium: "Palo", hard: "Caddy", very_hard: "Swing" } },
            { word: "Boxeo", hints: { easy: "Ring", medium: "Guantes", hard: "Pu√±o", very_hard: "KO" } },
            { word: "Esqu√≠", hints: { easy: "Nieve", medium: "Monta√±a", hard: "Bastones", very_hard: "Descenso" } },
            { word: "Surf", hints: { easy: "Ola", medium: "Tabla", hard: "Playa", very_hard: "Equilibrio" } },
            { word: "Ciclismo", hints: { easy: "Bici", medium: "Rueda", hard: "Casco", very_hard: "Pelot√≥n" } },
            { word: "Atletismo", hints: { easy: "Correr", medium: "Pista", hard: "Salto", very_hard: "Juegos" } },
            { word: "Rugby", hints: { easy: "Mel√©", medium: "Ovalo", hard: "Placaje", very_hard: "Ensayo" } },
            { word: "B√©isbol", hints: { easy: "Bate", medium: "Home", hard: "Gorra", very_hard: "Pitcher" } },
            { word: "Karate", hints: { easy: "Cintur√≥n", medium: "Kimono", hard: "Golpe", very_hard: "Dojo" } },
            { word: "F√≥rmula 1", hints: { easy: "Coche", medium: "R√°pido", hard: "Circuito", very_hard: "Boxes" } },
            { word: "Ajedrez", hints: { easy: "Tablero", medium: "Rey", hard: "Jaque", very_hard: "Estrategia" } },
            { word: "Pesca", hints: { easy: "Ca√±a", medium: "Pez", hard: "Anzuelo", very_hard: "Paciencia" } },
            { word: "Escalada", hints: { easy: "Roca", medium: "Subir", hard: "Cuerda", very_hard: "Arn√©s" } }
        ],
        instrumentos: [
            { word: "Guitarra", hints: { easy: "Cuerdas", medium: "P√∫a", hard: "Traste", very_hard: "Resonancia" } },
            { word: "Piano", hints: { easy: "Teclas", medium: "Cola", hard: "Pedal", very_hard: "Armon√≠a" } },
            { word: "Bater√≠a", hints: { easy: "Ritmo", medium: "Platillos", hard: "Ruido", very_hard: "Bombo" } },
            { word: "Viol√≠n", hints: { easy: "Arco", medium: "Hombro", hard: "Peque√±o", very_hard: "Orquesta" } },
            { word: "Trompeta", hints: { easy: "Viento", medium: "Dorado", hard: "Soplido", very_hard: "Jazz" } },
            { word: "Saxof√≥n", hints: { easy: "Curvo", medium: "Jazz", hard: "Metal", very_hard: "Lisa" } },
            { word: "Flauta", hints: { easy: "Larga", medium: "Agujeros", hard: "Dulce", very_hard: "Soplo" } },
            { word: "Arpa", hints: { easy: "√Ångel", medium: "Grande", hard: "Dedos", very_hard: "Cuerdas" } },
            { word: "Maracas", hints: { easy: "Agitar", medium: "Pareja", hard: "Ritmo", very_hard: "Percusi√≥n" } },
            { word: "Acorde√≥n", hints: { easy: "Fuelle", medium: "Pecho", hard: "Teclas", very_hard: "Aire" } },
            { word: "Clarinete", hints: { easy: "Negro", medium: "Madera", hard: "Calamardo", very_hard: "Boquilla" } },
            { word: "Banjo", hints: { easy: "Country", medium: "Redondo", hard: "Cuerdas", very_hard: "Folk" } },
            { word: "Ukelele", hints: { easy: "Peque√±o", medium: "Hawai", hard: "Cuatro", very_hard: "Guitarrita" } },
            { word: "Tromb√≥n", hints: { easy: "Vara", medium: "Largo", hard: "Metal", very_hard: "Grave" } },
            { word: "Tambor", hints: { easy: "Golpe", medium: "Redoble", hard: "Palillos", very_hard: "Membrana" } },
            { word: "Xil√≥fono", hints: { easy: "Colores", medium: "Placas", hard: "Madera", very_hard: "Mazzas" } },
            { word: "Gaita", hints: { easy: "Escocia", medium: "Bolsa", hard: "Falda", very_hard: "Soplido" } }
        ],
        ropa: [
            { word: "Camiseta", hints: { easy: "Algod√≥n", medium: "Manga", hard: "Cuello", very_hard: "Textil" } },
            { word: "Pantal√≥n", hints: { easy: "Piernas", medium: "Cintur√≥n", hard: "Bolsillos", very_hard: "Dobladillo" } },
            { word: "Zapatos", hints: { easy: "Suela", medium: "Cordones", hard: "Caminar", very_hard: "Empeine" } },
            { word: "Vestido", hints: { easy: "Mujer", medium: "Fiesta", hard: "Largo", very_hard: "Elegancia" } },
            { word: "Falda", hints: { easy: "Piernas", medium: "Vuelo", hard: "Escocesa", very_hard: "Minifalda" } },
            { word: "Chaqueta", hints: { easy: "Fr√≠o", medium: "Cierre", hard: "Abrir", very_hard: "Americana" } },
            { word: "Abrigo", hints: { easy: "Invierno", medium: "Largo", hard: "Calor", very_hard: "Lana" } },
            { word: "Sombrero", hints: { easy: "Cabeza", medium: "Sol", hard: "Ala", very_hard: "Copa" } },
            { word: "Guantes", hints: { easy: "Manos", medium: "Dedos", hard: "Nieve", very_hard: "Lana" } },
            { word: "Bufanda", hints: { easy: "Cuello", medium: "Larga", hard: "Nudo", very_hard: "Garganta" } },
            { word: "Calcetines", hints: { easy: "Pies", medium: "Pares", hard: "Olor", very_hard: "Algod√≥n" } },
            { word: "Ropa interior", hints: { easy: "Debajo", medium: "√çntimo", hard: "Oculto", very_hard: "Lencer√≠a" } },
            { word: "Ba√±ador", hints: { easy: "Agua", medium: "Playa", hard: "Verano", very_hard: "Piscina" } },
            { word: "Corbata", hints: { easy: "Cuello", medium: "Nudo", hard: "Traje", very_hard: "Formal" } },
            { word: "Cintur√≥n", hints: { easy: "Cintura", medium: "Hebilla", hard: "Cuero", very_hard: "Sujetar" } },
            { word: "Pijama", hints: { easy: "Dormir", medium: "Cama", hard: "Noche", very_hard: "Comodidad" } },
            { word: "Gorra", hints: { easy: "Cabeza", medium: "Visera", hard: "Deporte", very_hard: "Sol" } },
            { word: "Tacones", hints: { easy: "Alto", medium: "Ruido", hard: "Elegante", very_hard: "Equilibrio" } },
            { word: "Botas", hints: { easy: "Lluvia", medium: "Fuertes", hard: "Militares", very_hard: "Tobillo" } }
        ]
    };

    function toggleTheme() {
        const checkbox = document.getElementById('checkbox-theme');
        if(checkbox.checked) { document.body.classList.add('light-mode'); localStorage.setItem('theme', 'light'); }
        else { document.body.classList.remove('light-mode'); localStorage.setItem('theme', 'dark'); }
    }
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { document.body.classList.add('light-mode'); document.getElementById('checkbox-theme').checked = true; }

    function shareWhatsApp() {
        const url = window.location.href;
        const message = `üïµÔ∏è ¬°√önete a la partida!\nüîó ${url}\nüîë C√≥digo: *${roomId}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.getElementById('review-overlay').style.display = 'none';
        if(screenId === 'game-screen') requestWakeLock();
    }

    function selectMode(mode) {
        CURRENT_MODE = mode;
        if(mode === 'online') switchScreen('online-home-screen');
        else switchScreen('offline-setup-screen');
    }

    function goBackToMode() {
        switchScreen('mode-selection-screen');
        if (roomId && myId && CURRENT_MODE === 'online') { db.ref('rooms/' + roomId + '/players/' + myId).remove(); }
        roomId = "";
    }

    function disableButton(btnId) {
        const btn = document.getElementById(btnId);
        if(btn) btn.disabled = true;
        setTimeout(() => { if(btn) btn.disabled = false; }, 2000); 
    }

    // --- FUNCI√ìN SELECCI√ìN PALABRA (Con Memoria) ---
    function getUnusedWord(categoryKey, usedList) {
        let candidateItems = [];
        if (categoryKey === 'random') {
            Object.keys(database).forEach(key => { candidateItems = candidateItems.concat(database[key]); });
        } else {
            candidateItems = database[categoryKey];
        }

        const availableItems = candidateItems.filter(item => !usedList.includes(item.word));

        // Si se acaban, reciclamos
        if (availableItems.length === 0) {
            const randomItem = candidateItems[Math.floor(Math.random() * candidateItems.length)];
            return { item: randomItem, reset: true }; 
        }

        const randomItem = availableItems[Math.floor(Math.random() * availableItems.length)];
        return { item: randomItem, reset: false };
    }

    // --- ONLINE ---
    function createRoom() {
        disableButton('btn-create');
        const rawName = document.getElementById('player-name-input').value.trim();
        const name = escapeHtml(rawName); 
        
        if (!name) return alert("Escribe tu nombre.");
        myName = name; isHost = true;
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const initialSettings = { imposterCount: "random", category: "random", difficulty: "medium", imposterSeesCategory: "no" };
        db.ref('rooms/' + roomId).set({ status: 'lobby', settings: initialSettings, usedWords: [], createdAt: firebase.database.ServerValue.TIMESTAMP }).then(() => { joinGameLogic(); });
    }

    function joinRoom() {
        disableButton('btn-join');
        const rawName = document.getElementById('player-name-input').value.trim();
        const name = escapeHtml(rawName);
        const code = document.getElementById('room-code-input').value.trim().toUpperCase().replace(/\s/g, '');
        if (!name) return alert("Escribe tu nombre.");
        if (!code) return alert("Escribe el c√≥digo.");
        myName = name; roomId = code; isHost = false;
        db.ref('rooms/' + roomId).once('value', snapshot => {
            if (snapshot.exists()) { joinGameLogic(); } else { alert("Sala no encontrada."); }
        });
    }

    function joinGameLogic() {
        const playerRef = db.ref('rooms/' + roomId + '/players').push();
        myId = playerRef.key; localStorage.setItem('impostor_myId', myId);
        playerRef.onDisconnect().remove();
        playerRef.set({ name: myName, isHost: isHost, score: 0 }).then(() => { enterLobbyUI(); listenToRoom(); }).catch(err => { alert("Error al entrar: " + err.message); });
    }

    function enterLobbyUI() {
        switchScreen('lobby-screen');
        document.getElementById('display-room-code').innerText = roomId;
        updateUIForHost();
    }

    function syncSettings() {
        if (!isHost || CURRENT_MODE === 'offline') return;
        const settings = {
            imposterCount: document.getElementById('imposter-count').value,
            category: document.getElementById('category-select').value,
            difficulty: document.getElementById('difficulty-select').value,
            imposterSeesCategory: document.getElementById('imposter-sees-category').value
        };
        db.ref('rooms/' + roomId + '/settings').set(settings);
    }

    function updateUIForHost() {
        if (CURRENT_MODE === 'offline') return;
        const selects = ['imposter-count', 'category-select', 'difficulty-select', 'imposter-sees-category'];
        const startBtn = document.getElementById('btn-start-game');
        const waitMsg = document.getElementById('waiting-msg');
        const statusText = document.getElementById('settings-status-text');
        
        const gameControls = document.getElementById('host-game-controls');
        const voteControls = document.getElementById('host-voting-controls'); 
        const scoreControls = document.getElementById('host-score-controls');
        const restartControls = document.getElementById('host-restart-controls');
        const clientWait = document.getElementById('client-wait-restart');

        if (isHost) {
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = false;
            });
            startBtn.style.display = 'block'; waitMsg.style.display = 'none'; statusText.innerText = "(T√∫ eres el anfitri√≥n)";
            if(document.getElementById('game-screen').classList.contains('active')) gameControls.style.display = 'block';
            if(document.getElementById('voting-screen').classList.contains('active')) voteControls.style.display = 'block';
            if(document.getElementById('result-screen').classList.contains('active')) { scoreControls.style.display = 'block'; restartControls.style.display = 'block'; clientWait.style.display = 'none'; }
        } else {
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = true;
            });
            startBtn.style.display = 'none'; waitMsg.style.display = 'block'; statusText.innerText = "(Solo lectura)";
            gameControls.style.display = 'none'; voteControls.style.display = 'none'; scoreControls.style.display = 'none'; restartControls.style.display = 'none';
            if(document.getElementById('result-screen').classList.contains('active')) clientWait.style.display = 'block';
        }
    }

    function listenToRoom() {
        const roomRef = db.ref('rooms/' + roomId);
        
        roomRef.child('players').on('value', snapshot => {
            const list = document.getElementById('player-list-lobby'); list.innerHTML = ""; playersInRoom = [];
            let hostExists = false; let firstPlayerId = null;
            snapshot.forEach(child => {
                const p = child.val(); p.id = child.key;
                if (!firstPlayerId) firstPlayerId = p.id;
                if (p.isHost) hostExists = true;
                playersInRoom.push(p);
            });
            // SORTING ONLINE
            playersInRoom.sort((a, b) => (b.score || 0) - (a.score || 0));

            playersInRoom.forEach(p => {
                const li = document.createElement('li'); li.className = 'lobby-player';
                li.innerHTML = `<span>${p.isHost ? '<span class="host-badge">HOST</span>' : 'üë§'} ${p.name} ${p.id === myId ? '<span class="me-badge">T√ö</span>' : ''}</span> <span class="score-badge">${p.score || 0} pts</span>`;
                list.appendChild(li);
            });

            if (!hostExists && playersInRoom.length > 0 && myId === firstPlayerId) {
                db.ref('rooms/' + roomId + '/players/' + myId).update({ isHost: true }); isHost = true;
            }
            const me = playersInRoom.find(p => p.id === myId);
            if (me) { isHost = me.isHost; updateUIForHost(); }
        });

        roomRef.child('settings').on('value', snapshot => {
            const settings = snapshot.val();
            if (settings) {
                document.getElementById('imposter-count').value = settings.imposterCount;
                document.getElementById('category-select').value = settings.category;
                document.getElementById('difficulty-select').value = settings.difficulty;
                if(settings.imposterSeesCategory) document.getElementById('imposter-sees-category').value = settings.imposterSeesCategory;
            }
        });

        roomRef.child('gameState').on('value', snapshot => {
            const state = snapshot.val();
            if (!state) return;
            currentGameState = state;

            if (state.phase === 'assigned') {
                if (state.roles && state.roles[myId]) {
                    mySavedRoleData = { 
                        ...state.roles[myId], 
                        categoryName: state.categoryName,
                        imposterSeesCategory: state.imposterSeesCategory 
                    };
                    revealMyRole(mySavedRoleData);
                } else {
                    document.getElementById('role-text').innerText = "Sincronizando...";
                    setTimeout(() => {}, 500); 
                }
            } else if (state.phase === 'playing') {
                startLocalTimer(state.endTime, state.starterName);
            } else if (state.phase === 'voting') {
                showVotingScreen();
            } else if (state.phase === 'finished') {
                showResults(state);
            } else if (state.phase === 'reset') {
                resetLocalGame();
            }
        });
    }

    // --- START GAME ONLINE ---
    function startGame() {
        if (!isHost) return;
        if (playersInRoom.length < 3) return alert("Se necesitan al menos 3 jugadores.");
        
        const categoryKey = document.getElementById('category-select').value;
        const difficulty = document.getElementById('difficulty-select').value;
        const imposterSetting = document.getElementById('imposter-count').value;
        const seesCategory = document.getElementById('imposter-sees-category').value === 'yes';

        // Validaci√≥n 3 impostores (m√≠nimo 4 jugadores)
        if (imposterSetting === "3" && playersInRoom.length < 4) return alert("Para 3 impostores se necesitan al menos 4 jugadores.");

        db.ref('rooms/' + roomId + '/usedWords').once('value', snapshot => {
            const usedWords = snapshot.val() || [];
            const selection = getUnusedWord(categoryKey, usedWords);
            const secretItem = selection.item;
            let newUsedWords = selection.reset ? [secretItem.word] : [...usedWords, secretItem.word];
            
            db.ref('rooms/' + roomId + '/usedWords').set(newUsedWords);
            startSharedGameLogic(playersInRoom, imposterSetting, categoryKey, difficulty, secretItem, seesCategory);
        });
    }

    // --- START GAME OFFLINE ---
    function startOfflineGame() {
        if (offlinePlayers.length < 3) return alert("M√≠nimo 3 jugadores.");
        
        const categoryKey = document.getElementById('offline-category-select').value;
        const difficulty = document.getElementById('offline-difficulty-select').value;
        const imposterSetting = document.getElementById('offline-imposter-count').value;
        const seesCategory = document.getElementById('offline-imposter-sees-category').value === 'yes';

        if (imposterSetting !== 'random' && offlinePlayers.length <= parseInt(imposterSetting)) return alert("Demasiados impostores.");
        
        // Validaci√≥n 3 impostores offline
        if (imposterSetting === "3" && offlinePlayers.length < 4) return alert("Para 3 impostores se necesitan al menos 4 jugadores.");

        const selection = getUnusedWord(categoryKey, offlineUsedWords);
        const secretItem = selection.item;
        
        if (selection.reset) offlineUsedWords = [secretItem.word];
        else offlineUsedWords.push(secretItem.word);

        const setup = calculateGameSetup(offlinePlayers, imposterSetting, categoryKey, difficulty, secretItem);
        currentGameState = { ...setup, imposterSeesCategory: seesCategory };
        currentOfflineIndex = 0;
        showOfflinePassScreen();
    }

    function calculateGameSetup(playersArray, imposterSetting, categoryKey, difficulty, secretItem) {
        let imposterCount = 1;
        if (imposterSetting === 'random') {
            const count = playersArray.length;
            if (count < 5) imposterCount = 1;
            else if (count < 7) imposterCount = Math.floor(Math.random() * 2) + 1; // 1 or 2
            else imposterCount = Math.floor(Math.random() * 3) + 1; // 1, 2 or 3
        } else {
            imposterCount = parseInt(imposterSetting);
        }

        let indices = playersArray.map((_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        
        const impostorIndices = indices.slice(0, imposterCount);
        const starterIndex = Math.floor(Math.random() * playersArray.length);
        const starterName = playersArray[starterIndex].name;

        let rolesMap = {};
        let impostorNames = [];

        playersArray.forEach((p, i) => {
            let isImposter = impostorIndices.includes(i);
            if(isImposter) impostorNames.push(p.name);
            rolesMap[p.id] = {
                isImposter: isImposter,
                word: secretItem.word,
                hint: secretItem.hints[difficulty] || "Sin pista",
                showHint: difficulty !== 'none'
            };
        });

        let catName = categoryKey.toUpperCase();
        if (categoryKey === 'random') {
             for (const [key, items] of Object.entries(database)) {
                if (items.some(i => i.word === secretItem.word)) {
                    catName = key.toUpperCase();
                    break;
                }
            }
        }

        return {
            categoryName: catName,
            roles: rolesMap,
            impostorNames: impostorNames,
            secretWord: secretItem.word,
            starterName: starterName
        };
    }

    function startSharedGameLogic(players, imposterSetting, catKey, diff, secretItem, seesCategory) {
        const setup = calculateGameSetup(players, imposterSetting, catKey, diff, secretItem);
        db.ref('rooms/' + roomId + '/gameState').set({
            phase: 'assigned',
            categoryName: setup.categoryName,
            roles: setup.roles,
            impostorNames: setup.impostorNames,
            secretWord: setup.secretWord,
            starterName: setup.starterName,
            imposterSeesCategory: seesCategory,
            votes: {} 
        });
    }

    function confirmRoleSeen() {
        if (CURRENT_MODE === 'online') {
            switchScreen('game-screen');
            document.getElementById('timer').innerText = "ESPERANDO...";
            document.getElementById('starter-name').innerText = "...";
            document.getElementById('btn-review-role').style.display = 'block';
            document.getElementById('host-game-controls').style.display = 'none';
            if(isHost) {
                 const now = Date.now();
                 const duration = 180 * 1000; 
                 db.ref('rooms/' + roomId + '/gameState').update({
                    phase: 'playing', startTime: now, endTime: now + duration
                });
            }
        } else {
            nextOfflinePlayer();
        }
    }

    function goToGame() { confirmRoleSeen(); }

    function revealMyRole(data) {
        switchScreen('role-screen');
        const card = document.getElementById('role-card-display');
        const text = document.getElementById('role-text');
        const hint = document.getElementById('role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        
        if (data.isImposter) {
            card.classList.add('imposter-reveal'); 
            text.innerText = "üïµÔ∏è IMPOSTOR";
            if (data.showHint) { 
                hint.style.display = 'block'; 
                hint.innerText = "Pista: " + data.hint; 
            }
            
            // L√≥gica de visualizaci√≥n de categor√≠a
            if (data.imposterSeesCategory) {
                document.getElementById('category-display').innerText = "Categor√≠a: " + data.categoryName;
            } else {
                document.getElementById('category-display').innerText = "Categor√≠a: ‚ùì"; 
            }
        } else { 
            text.innerText = data.word; 
            document.getElementById('category-display').innerText = "Categor√≠a: " + data.categoryName;
        }
    }

    function startLocalTimer(endTime, starterName) {
        switchScreen('game-screen');
        document.getElementById('starter-name').innerText = starterName;
        
        if (CURRENT_MODE === 'online') {
            updateUIForHost();
            document.getElementById('offline-game-controls').style.display = 'none';
            document.getElementById('btn-review-role').style.display = 'block';
        } else {
            document.getElementById('host-game-controls').style.display = 'none';
            document.getElementById('offline-game-controls').style.display = 'block';
            document.getElementById('btn-review-role').style.display = 'none';
        }

        if(timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const now = Date.now();
            const left = Math.max(0, Math.floor((endTime - now) / 1000));
            const m = Math.floor(left / 60).toString().padStart(2,'0');
            const s = (left % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            if (left <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "00:00";
                if (CURRENT_MODE === 'online' && isHost) startVotingGlobal();
            }
        }, 1000);
    }

    function startVotingGlobal() {
        db.ref('rooms/' + roomId + '/gameState').update({ phase: 'voting' });
    }

    function showVotingScreen() {
        clearInterval(timerInterval);
        switchScreen('voting-screen');
        hasVoted = false;
        document.getElementById('vote-status').innerText = "Toca un nombre para acusar:";
        
        const container = document.getElementById('voting-buttons-container');
        container.innerHTML = "";

        playersInRoom.forEach(p => {
            if (p.id === myId) return; 
            const btn = document.createElement('button');
            btn.className = 'vote-btn';
            btn.innerHTML = `<span>üë§ ${p.name}</span>`;
            btn.onclick = () => castVote(p.id, btn);
            container.appendChild(btn);
        });
        updateUIForHost();
    }

    function castVote(targetId, btnElement) {
        if (hasVoted) return;
        hasVoted = true;
        const allBtns = document.querySelectorAll('.vote-btn');
        allBtns.forEach(b => b.style.opacity = '0.5');
        btnElement.style.opacity = '1';
        btnElement.classList.add('selected');
        document.getElementById('vote-status').innerText = "Voto enviado. Esperando...";
        db.ref('rooms/' + roomId + '/gameState/votes/' + myId).set(targetId);
    }

    function endGameGlobal() {
        if (CURRENT_MODE === 'online') {
            db.ref('rooms/' + roomId + '/gameState').update({ phase: 'finished' });
        } else {
            showResults(currentGameState);
        }
    }

    function showResults(state) {
        clearInterval(timerInterval);
        switchScreen('result-screen');
        document.getElementById('result-impostors').innerText = state.impostorNames.join(" y ");
        document.getElementById('result-word').innerText = state.secretWord;

        const voteBox = document.getElementById('voting-results-display');
        const votesList = document.getElementById('votes-list');
        
        if (CURRENT_MODE === 'online' && state.votes) {
            voteBox.style.display = 'block';
            votesList.innerHTML = "";
            let voteCounts = {};
            Object.values(state.votes).forEach(targetId => { voteCounts[targetId] = (voteCounts[targetId] || 0) + 1; });
            for (let [targetId, count] of Object.entries(voteCounts)) {
                const p = playersInRoom.find(pl => pl.id === targetId);
                const name = p ? p.name : "Desconocido";
                const isImp = state.roles[targetId] && state.roles[targetId].isImposter;
                const li = document.createElement('li');
                li.innerHTML = `<b>${name}</b>: ${count} votos ${isImp ? 'üòà' : 'üòá'}`;
                votesList.appendChild(li);
            }
        } else { voteBox.style.display = 'none'; }

        if (CURRENT_MODE === 'online') {
            updateUIForHost();
            document.getElementById('offline-restart-btn').style.display = 'none';
            document.getElementById('offline-score-controls').style.display = 'none';
        } else {
            document.getElementById('host-score-controls').style.display = 'none';
            document.getElementById('host-restart-controls').style.display = 'none';
            document.getElementById('client-wait-restart').style.display = 'none';
            document.getElementById('offline-score-controls').style.display = 'block';
            document.getElementById('offline-restart-btn').style.display = 'block';
        }
    }

    // --- OFFLINE FUNCTIONS ---
    function handleEnterOffline(e) { if(e.key === 'Enter') addOfflinePlayer(); }
    
    function addOfflinePlayer() {
        const input = document.getElementById('offline-new-player');
        const name = escapeHtml(input.value.trim());
        if (name) {
            offlinePlayers.push({ name: name, id: 'off-' + Date.now() + Math.random(), score: 0 });
            input.value = "";
            renderOfflineList();
        }
    }

    function removeOfflinePlayer(index) {
        offlinePlayers.splice(index, 1);
        renderOfflineList();
    }

    function renderOfflineList() {
        const list = document.getElementById('offline-player-list');
        list.innerHTML = "";
        
        // SORTING OFFLINE
        offlinePlayers.sort((a, b) => (b.score || 0) - (a.score || 0));

        offlinePlayers.forEach((p, i) => {
            const li = document.createElement('li');
            li.className = 'player-item';
            li.innerHTML = `<span>üë§ ${p.name} <span class="score-badge">${p.score} pts</span></span><button class="delete-btn" onclick="removeOfflinePlayer(${i})">‚úï</button>`;
            list.appendChild(li);
        });
    }

    function showOfflinePassScreen() {
        switchScreen('offline-pass-screen');
        const p = offlinePlayers[currentOfflineIndex];
        document.getElementById('offline-current-player-display').innerText = p.name;
        document.getElementById('offline-current-player-text').innerText = p.name;
    }

    function showOfflineRole() {
        const p = offlinePlayers[currentOfflineIndex];
        const roleData = currentGameState.roles[p.id];
        mySavedRoleData = { 
            ...roleData, 
            categoryName: currentGameState.categoryName,
            imposterSeesCategory: currentGameState.imposterSeesCategory
        }; 
        revealMyRole(mySavedRoleData);
    }

    function nextOfflinePlayer() {
        currentOfflineIndex++;
        if (currentOfflineIndex < offlinePlayers.length) {
            showOfflinePassScreen();
        } else {
            startLocalTimer(Date.now() + 180 * 1000, currentGameState.starterName);
        }
    }

    function distributeOfflinePoints(winnerType) {
        offlinePlayers.forEach(p => {
            const role = currentGameState.roles[p.id];
            if (winnerType === 'civilians' && !role.isImposter) p.score += 1;
            if (winnerType === 'impostors' && role.isImposter) p.score += 3;
        });
        renderOfflineList();
        resetOfflineGame();
    }

    function resetOfflineGame() { switchScreen('offline-setup-screen'); }

    // Helpers
    function openRoleReview() {
        if (!mySavedRoleData) return;
        const card = document.getElementById('review-card-display');
        const text = document.getElementById('review-role-text');
        const hint = document.getElementById('review-role-hint');
        card.classList.remove('imposter-reveal'); hint.style.display = 'none';
        
        if (mySavedRoleData.isImposter) {
            card.classList.add('imposter-reveal'); text.innerText = "üïµÔ∏è IMPOSTOR";
            if (mySavedRoleData.showHint) { hint.style.display = 'block'; hint.innerText = "Pista: " + mySavedRoleData.hint; }
            
            if (mySavedRoleData.imposterSeesCategory) {
                document.getElementById('review-category-display').innerText = "Categor√≠a: " + mySavedRoleData.categoryName;
            } else {
                document.getElementById('review-category-display').innerText = "Categor√≠a: ‚ùì";
            }
        } else { 
            text.innerText = mySavedRoleData.word; 
            document.getElementById('review-category-display').innerText = "Categor√≠a: " + mySavedRoleData.categoryName;
        }
        document.getElementById('review-overlay').style.display = 'flex';
    }
    function closeRoleReview() { document.getElementById('review-overlay').style.display = 'none'; }
    function exitGame() { if(confirm("¬øSalir?")) { if(roomId && myId && CURRENT_MODE === 'online') db.ref('rooms/' + roomId + '/players/' + myId).remove(); window.location.reload(); } }
    function distributePoints(winnerType) {
        if (!isHost || !currentGameState || !currentGameState.roles) return;
        const updates = {};
        playersInRoom.forEach(p => {
            const role = currentGameState.roles[p.id];
            let currentScore = p.score || 0;
            let pointsToAdd = 0;
            if (winnerType === 'civilians' && role && !role.isImposter) pointsToAdd = 1;
            if (winnerType === 'impostors' && role && role.isImposter) pointsToAdd = 3;
            if (pointsToAdd > 0) { updates['players/' + p.id + '/score'] = currentScore + pointsToAdd; }
        });
        db.ref('rooms/' + roomId).update(updates).then(() => { returnToLobbyGlobal(); });
    }
    function returnToLobbyGlobal() { if (CURRENT_MODE === 'online') { db.ref('rooms/' + roomId + '/gameState').set({ phase: 'reset' }); } }
    function resetLocalGame() { enterLobbyUI(); mySavedRoleData = null; }
</script>
</body>
</html>
